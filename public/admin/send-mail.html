<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ë©”ì¼ ë°œì†¡ - Audionyx</title>
  <link href="https://unpkg.com/tailwindcss@2/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    .bg-mint-500 { background-color: #20B2AA; }
    .bg-mint-600 { background-color: #008B8B; }
    .hover\:bg-mint-600:hover { background-color: #008B8B; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container mx-auto px-6 py-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-8 text-center">ğŸ“§ Audionyx ë©”ì¼ ë°œì†¡</h1>
      
      <!-- ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ -->
      <div id="auth-status" class="mb-6 p-4 rounded-lg bg-gray-800">
        <div id="logged-out" class="text-center">
          <p class="mb-4">ë©”ì¼ì„ ë°œì†¡í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
          <button id="login-btn" class="px-6 py-2 bg-green-500 hover:bg-green-600 rounded-lg font-semibold transition-colors">
            ğŸ”‘ Google ë¡œê·¸ì¸
          </button>
        </div>
        <div id="logged-in" class="hidden">
          <div class="flex justify-between items-center">
            <span id="user-info" class="text-green-400"></span>
            <button id="logout-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded text-sm transition-colors">
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </div>

      <!-- ë©”ì¼ ë°œì†¡ í¼ -->
      <div id="mail-form-container" class="hidden">
        <form id="mail-form" class="space-y-6 bg-gray-800 p-6 rounded-lg">
          <!-- ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼ ì„¹ì…˜ -->
          <div>
            <label class="block text-sm font-medium mb-2">ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼</label>
            
            <!-- ì…ë ¥ ë°©ì‹ ì„ íƒ íƒ­ -->
            <div class="flex mb-4 bg-gray-700 rounded-lg p-1">
              <button 
                type="button" 
                id="tab-individual" 
                class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-mint-500 text-white"
              >
                ê°œë³„ ì¶”ê°€
              </button>
              <button 
                type="button" 
                id="tab-bulk" 
                class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-300 hover:text-white"
              >
                ì¼ê´„ ì…ë ¥
              </button>
            </div>

            <!-- ê°œë³„ ì¶”ê°€ ë°©ì‹ -->
            <div id="individual-mode">
              <div class="space-y-2 mb-3" id="email-list">
                <div class="flex gap-2 email-item">
                  <input 
                    type="email" 
                    class="flex-1 p-3 text-black rounded-lg border border-gray-300 focus:ring-2 focus:ring-mint-500 focus:border-transparent email-input" 
                    placeholder="recipient@example.com"
                  />
                  <button 
                    type="button" 
                    class="px-3 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors remove-email"
                    title="ì´ë©”ì¼ ì œê±°"
                  >
                    âŒ
                  </button>
                </div>
              </div>
              <button 
                type="button" 
                id="add-email" 
                class="w-full py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
              >
                â• ì´ë©”ì¼ ì¶”ê°€
              </button>
              <div class="mt-2 text-sm text-gray-400">
                ğŸ’¡ íŒ: ê° ì´ë©”ì¼ ì£¼ì†Œë¥¼ ê°œë³„ì ìœ¼ë¡œ ì¶”ê°€í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
            </div>

            <!-- ì¼ê´„ ì…ë ¥ ë°©ì‹ -->
            <div id="bulk-mode" class="hidden">
              <textarea 
                id="bulk-emails" 
                rows="4"
                class="w-full p-3 text-black rounded-lg border border-gray-300 focus:ring-2 focus:ring-mint-500 focus:border-transparent" 
                placeholder="ì—¬ëŸ¬ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì‰¼í‘œ(,), ì„¸ë¯¸ì½œë¡ (;) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.&#10;&#10;ì˜ˆì‹œ:&#10;user1@example.com, user2@example.com&#10;user3@example.com"
              ></textarea>
              <div class="mt-2 text-sm text-gray-400">
                ğŸ’¡ íŒ: ì‰¼í‘œ(,), ì„¸ë¯¸ì½œë¡ (;) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ì´ë©”ì¼ì„ êµ¬ë¶„í•´ì£¼ì„¸ìš”.
              </div>
            </div>

            <!-- ì´ë©”ì¼ ê°œìˆ˜ í‘œì‹œ -->
            <div class="mt-2 text-sm text-mint-400" id="email-count">
              ğŸ“§ ë°œì†¡ ëŒ€ìƒ: <span id="email-count-number">1</span>ê°œ ì´ë©”ì¼
            </div>
          </div>
          
          <div>
            <label for="subject" class="block text-sm font-medium mb-2">ì œëª©</label>
            <input 
              id="subject" 
              type="text" 
              class="w-full p-3 text-black rounded-lg border border-gray-300 focus:ring-2 focus:ring-mint-500 focus:border-transparent" 
              placeholder="ë©”ì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>
          
          <div>
            <label for="html" class="block text-sm font-medium mb-2">ë©”ì¼ ë‚´ìš© (HTML)</label>
            <textarea 
              id="html" 
              rows="12"
              class="w-full p-3 text-black rounded-lg border border-gray-300 focus:ring-2 focus:ring-mint-500 focus:border-transparent font-mono text-sm" 
              placeholder="<h1>ì•ˆë…•í•˜ì„¸ìš”!</h1><p>ë©”ì¼ ë³¸ë¬¸ì„ HTMLë¡œ ì‘ì„±í•˜ì„¸ìš”.</p>"
              required
            ></textarea>
          </div>
          
          <div class="flex gap-4">
            <button 
              type="submit" 
              class="flex-1 bg-mint-500 hover:bg-mint-600 text-white p-3 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              id="send-btn"
            >
              ğŸ“¨ ë©”ì¼ ë°œì†¡
            </button>
            <button 
              type="button" 
              id="preview-btn"
              class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors"
            >
              ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
            </button>
          </div>
        </form>
      </div>

      <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
      <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white text-black p-6 rounded-lg max-w-4xl max-h-96 overflow-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">ë©”ì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
            <button id="close-preview" class="text-gray-500 hover:text-gray-700">âœ•</button>
          </div>
          <div id="preview-content" class="border p-4 rounded"></div>
        </div>
      </div>

      <!-- ë°œì†¡ ê²°ê³¼ -->
      <div id="result" class="mt-6 p-4 rounded-lg hidden"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-functions.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBP926ULg9wNUNGjQy0fMjRxUeS4XyeG6M",
      authDomain: "audionyx-a7b2e.firebaseapp.com",
      projectId: "audionyx-a7b2e",
      storageBucket: "audionyx-a7b2e.firebasestorage.app",
      messagingSenderId: "1002069862376",
      appId: "1:1002069862376:web:669c93bca8ab2f1d09665d",
      measurementId: "G-P6GNNYLJ38"
    };

    const app = initializeApp(firebaseConfig);
    const functions = getFunctions(app);
    const auth = getAuth(app);

    // DOM ìš”ì†Œë“¤
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const loggedOut = document.getElementById("logged-out");
    const loggedIn = document.getElementById("logged-in");
    const userInfo = document.getElementById("user-info");
    const mailFormContainer = document.getElementById("mail-form-container");
    const mailForm = document.getElementById("mail-form");
    const sendBtn = document.getElementById("send-btn");
    const previewBtn = document.getElementById("preview-btn");
    const previewModal = document.getElementById("preview-modal");
    const previewContent = document.getElementById("preview-content");
    const closePreview = document.getElementById("close-preview");
    const result = document.getElementById("result");

    // ìƒˆë¡œìš´ ì´ë©”ì¼ ê´€ë ¨ DOM ìš”ì†Œë“¤
    const tabIndividual = document.getElementById("tab-individual");
    const tabBulk = document.getElementById("tab-bulk");
    const individualMode = document.getElementById("individual-mode");
    const bulkMode = document.getElementById("bulk-mode");
    const emailList = document.getElementById("email-list");
    const addEmailBtn = document.getElementById("add-email");
    const bulkEmails = document.getElementById("bulk-emails");
    const emailCountNumber = document.getElementById("email-count-number");

    // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì¦ í•¨ìˆ˜
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email.trim());
    }

    // ì´ë©”ì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateEmailCount() {
      const emails = getAllEmails();
      emailCountNumber.textContent = emails.length;
    }

    // ëª¨ë“  ì´ë©”ì¼ ì£¼ì†Œ ìˆ˜ì§‘ í•¨ìˆ˜
    function getAllEmails() {
      if (individualMode.classList.contains("hidden")) {
        // ì¼ê´„ ì…ë ¥ ëª¨ë“œ
        const bulkText = bulkEmails.value.trim();
        if (!bulkText) return [];
        
        return bulkText
          .split(/[,;\n]/)
          .map(email => email.trim())
          .filter(email => email && isValidEmail(email));
      } else {
        // ê°œë³„ ì¶”ê°€ ëª¨ë“œ
        const emailInputs = emailList.querySelectorAll(".email-input");
        const emails = [];
        emailInputs.forEach(input => {
          const email = input.value.trim();
          if (email && isValidEmail(email)) {
            emails.push(email);
          }
        });
        return emails;
      }
    }

    // ì´ë©”ì¼ ì•„ì´í…œ ìƒì„± í•¨ìˆ˜
    function createEmailItem() {
      const emailItem = document.createElement("div");
      emailItem.className = "flex gap-2 email-item";
      emailItem.innerHTML = `
        <input 
          type="email" 
          class="flex-1 p-3 text-black rounded-lg border border-gray-300 focus:ring-2 focus:ring-mint-500 focus:border-transparent email-input" 
          placeholder="recipient@example.com"
        />
        <button 
          type="button" 
          class="px-3 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors remove-email"
          title="ì´ë©”ì¼ ì œê±°"
        >
          âŒ
        </button>
      `;

      // ì´ë©”ì¼ ì…ë ¥ ì‹œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      const emailInput = emailItem.querySelector(".email-input");
      emailInput.addEventListener("input", updateEmailCount);

      // ì œê±° ë²„íŠ¼ ì´ë²¤íŠ¸
      const removeBtn = emailItem.querySelector(".remove-email");
      removeBtn.addEventListener("click", () => {
        if (emailList.children.length > 1) {
          emailItem.remove();
          updateEmailCount();
        }
      });

      return emailItem;
    }

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function switchTab(mode) {
      if (mode === "individual") {
        tabIndividual.classList.add("bg-mint-500", "text-white");
        tabIndividual.classList.remove("text-gray-300");
        tabBulk.classList.remove("bg-mint-500", "text-white");
        tabBulk.classList.add("text-gray-300");
        
        individualMode.classList.remove("hidden");
        bulkMode.classList.add("hidden");
      } else {
        tabBulk.classList.add("bg-mint-500", "text-white");
        tabBulk.classList.remove("text-gray-300");
        tabIndividual.classList.remove("bg-mint-500", "text-white");
        tabIndividual.classList.add("text-gray-300");
        
        bulkMode.classList.remove("hidden");
        individualMode.classList.add("hidden");
      }
      updateEmailCount();
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    tabIndividual.addEventListener("click", () => switchTab("individual"));
    tabBulk.addEventListener("click", () => switchTab("bulk"));

    // ì´ë©”ì¼ ì¶”ê°€ ë²„íŠ¼
    addEmailBtn.addEventListener("click", () => {
      const newEmailItem = createEmailItem();
      emailList.appendChild(newEmailItem);
      newEmailItem.querySelector(".email-input").focus();
      updateEmailCount();
    });

    // ì¼ê´„ ì…ë ¥ í…ìŠ¤íŠ¸ ë³€ê²½ ì‹œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    bulkEmails.addEventListener("input", updateEmailCount);

    // ì´ˆê¸° ì´ë©”ì¼ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelector(".email-input").addEventListener("input", updateEmailCount);
    document.querySelector(".remove-email").addEventListener("click", (e) => {
      if (emailList.children.length > 1) {
        e.target.closest(".email-item").remove();
        updateEmailCount();
      }
    });

    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loggedOut.classList.add("hidden");
        loggedIn.classList.remove("hidden");
        mailFormContainer.classList.remove("hidden");
        userInfo.textContent = `ğŸ‘¤ ${user.displayName || user.email}`;
      } else {
        loggedOut.classList.remove("hidden");
        loggedIn.classList.add("hidden");
        mailFormContainer.classList.add("hidden");
      }
    });

    // ë¡œê·¸ì¸
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch (error) {
        console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
        showResult("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
      }
    });

    // ë¡œê·¸ì•„ì›ƒ
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error);
      }
    });

    // ë¯¸ë¦¬ë³´ê¸°
    previewBtn.addEventListener("click", () => {
      const html = document.getElementById("html").value;
      previewContent.innerHTML = html;
      previewModal.classList.remove("hidden");
    });

    closePreview.addEventListener("click", () => {
      previewModal.classList.add("hidden");
    });

    // ë©”ì¼ ë°œì†¡
    mailForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const emails = getAllEmails();
      const subject = document.getElementById("subject").value.trim();
      const html = document.getElementById("html").value;

      // ìœ íš¨ì„± ê²€ì¦
      if (emails.length === 0) {
        showResult("âŒ ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      if (!subject || !html) {
        showResult("âŒ ì œëª©ê³¼ ë©”ì¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      // ì¸ì¦ ìƒíƒœ í™•ì¸
      const currentUser = auth.currentUser;
      if (!currentUser) {
        showResult("âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
        return;
      }

      console.log("ë°œì†¡ ëŒ€ìƒ ì´ë©”ì¼:", emails);
      console.log("ì´ë©”ì¼ ê°œìˆ˜:", emails.length);

      // ì „ì†¡í•  ë°ì´í„° ì¤€ë¹„
      const mailData = { 
        to: emails.length === 1 ? emails[0] : emails, // ë‹¨ì¼ ì´ë©”ì¼ì´ë©´ ë¬¸ìì—´, ì—¬ëŸ¬ ê°œë©´ ë°°ì—´
        subject, 
        html 
      };

      sendBtn.disabled = true;
      sendBtn.textContent = `ğŸ“¨ ${emails.length}ê°œ ì´ë©”ì¼ë¡œ ë°œì†¡ ì¤‘...`;

      try {
        const sendMail = httpsCallable(functions, "sendMail");
        const result = await sendMail(mailData);
        console.log("Functions ì‘ë‹µ:", result);
        
        const responseData = result.data;
        const sentCount = responseData.count || emails.length;
        const sentEmails = responseData.sentTo || emails;
        
        showResult(
          `âœ… ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n` +
          `ğŸ“§ ë°œì†¡ ì™„ë£Œ: ${sentCount}ê°œ ì´ë©”ì¼\n` +
          `ğŸ“‹ ìˆ˜ì‹ ì: ${sentEmails.slice(0, 3).join(", ")}${sentEmails.length > 3 ? ` ì™¸ ${sentEmails.length - 3}ëª…` : ""}`, 
          "success"
        );
        
        // í¼ ì´ˆê¸°í™”
        mailForm.reset();
        
        // ê°œë³„ ì¶”ê°€ ëª¨ë“œë¼ë©´ ì´ë©”ì¼ ëª©ë¡ë„ ì´ˆê¸°í™”
        if (!individualMode.classList.contains("hidden")) {
          emailList.innerHTML = `
            <div class="flex gap-2 email-item">
              <input 
                type="email" 
                class="flex-1 p-3 text-black rounded-lg border border-gray-300 focus:ring-2 focus:ring-mint-500 focus:border-transparent email-input" 
                placeholder="recipient@example.com"
              />
              <button 
                type="button" 
                class="px-3 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors remove-email"
                title="ì´ë©”ì¼ ì œê±°"
              >
                âŒ
              </button>
            </div>
          `;
          // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì¶”ê°€
          document.querySelector(".email-input").addEventListener("input", updateEmailCount);
          document.querySelector(".remove-email").addEventListener("click", (e) => {
            if (emailList.children.length > 1) {
              e.target.closest(".email-item").remove();
              updateEmailCount();
            }
          });
        }
        
        updateEmailCount();
        
      } catch (error) {
        console.error("ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜:", error);
        console.error("ì˜¤ë¥˜ ìƒì„¸:", {
          code: error.code,
          message: error.message,
          details: error.details
        });
        showResult(
          `âŒ ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n` +
          `ğŸ’¬ ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message}\n` +
          `ğŸ¯ ëŒ€ìƒ ì´ë©”ì¼: ${emails.length}ê°œ`, 
          "error"
        );
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "ğŸ“¨ ë©”ì¼ ë°œì†¡";
      }
    });

    // ê²°ê³¼ í‘œì‹œ
    function showResult(message, type) {
      result.textContent = message;
      result.className = `mt-6 p-4 rounded-lg ${type === "success" ? "bg-green-800 text-green-200" : "bg-red-800 text-red-200"}`;
      result.classList.remove("hidden");
      
      setTimeout(() => {
        result.classList.add("hidden");
      }, 5000);
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    previewModal.addEventListener("click", (e) => {
      if (e.target === previewModal) {
        previewModal.classList.add("hidden");
      }
    });
  </script>
</body>
</html> 