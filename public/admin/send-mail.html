<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>메일 발송 - Audionyx</title>
  <link href="https://unpkg.com/tailwindcss@2/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #3EB489;
      --color-primary-hover: #2A9D74;
      --color-accent: #A8E6CE;
      --color-neutral-dark: #0C0C0C;
      --color-surface: #FFFFFF;
      --color-border: #2A9D74;
      --color-text-light: #F0FFF0;
      --color-text-gray: #A7D3C9;
      --dark-bg: #000000;
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
      --radius-lg: 16px;
      --radius-md: 8px;
      --font-primary: 'Inter', 'Pretendard', sans-serif;
    }
    
    body {
      font-family: var(--font-primary);
      background: linear-gradient(135deg, #000000 0%, #0A0A0A 100%);
      color: var(--color-text-light);
    }
    
    .audionyx-card {
      background: linear-gradient(145deg, rgba(12, 12, 12, 0.9) 0%, rgba(20, 20, 20, 0.8) 100%);
      border: 1px solid rgba(62, 180, 137, 0.2);
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(10px);
    }
    
    .audionyx-btn-primary {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
      color: var(--color-neutral-dark);
      font-weight: 600;
      border: 1px solid rgba(168, 230, 206, 0.3);
      box-shadow: 0 4px 20px rgba(62, 180, 137, 0.4);
      transition: all 0.3s ease;
    }
    
    .audionyx-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(62, 180, 137, 0.6);
    }
    
    .audionyx-btn-secondary {
      background: rgba(62, 180, 137, 0.1);
      color: var(--color-text-light);
      border: 1px solid rgba(62, 180, 137, 0.3);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .audionyx-btn-secondary:hover {
      background: rgba(62, 180, 137, 0.2);
      border-color: var(--color-primary);
    }
    
    .audionyx-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(62, 180, 137, 0.2);
      color: var(--color-text-light);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .audionyx-input:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(62, 180, 137, 0.2);
      background: rgba(255, 255, 255, 0.08);
    }
    
    .audionyx-input::placeholder {
      color: var(--color-text-gray);
    }
    
    .audionyx-tab-active {
      background: var(--color-primary);
      color: var(--color-neutral-dark);
      box-shadow: 0 4px 12px rgba(62, 180, 137, 0.3);
    }
    
    .audionyx-tab-inactive {
      background: rgba(62, 180, 137, 0.1);
      color: var(--color-text-gray);
      border: 1px solid rgba(62, 180, 137, 0.2);
    }
    
    .audionyx-tab-inactive:hover {
      background: rgba(62, 180, 137, 0.15);
      color: var(--color-text-light);
    }
    
    .audionyx-success {
      background: linear-gradient(135deg, rgba(62, 180, 137, 0.2) 0%, rgba(42, 157, 116, 0.1) 100%);
      border: 1px solid rgba(62, 180, 137, 0.4);
      color: var(--color-accent);
    }
    
    .audionyx-warning {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 193, 7, 0.1) 100%);
      border: 1px solid rgba(255, 193, 7, 0.4);
      color: #FFE082;
    }
    
    .audionyx-error {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.2) 0%, rgba(244, 67, 54, 0.1) 100%);
      border: 1px solid rgba(244, 67, 54, 0.4);
      color: #FFCDD2;
    }
    
    .audionyx-gradient-border {
      position: relative;
      background: linear-gradient(145deg, rgba(12, 12, 12, 0.9) 0%, rgba(20, 20, 20, 0.8) 100%);
    }
    
    .audionyx-gradient-border::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: subtract;
      -webkit-mask-composite: xor;
    }
    
    .glass-effect {
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-6 py-12">
    <div class="max-w-5xl mx-auto">
      <!-- 헤더 섹션 -->
      <div class="text-center mb-12">
        <div class="inline-flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center">
            <span class="text-2xl">📧</span>
          </div>
          <h1 class="text-4xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
            AUDIONYX
          </h1>
        </div>
        <p class="text-xl font-semibold mb-2" style="color: var(--color-text-light);">관리자 메일 발송 시스템</p>
        <p class="text-sm opacity-75" style="color: var(--color-text-gray);">개별 1대1 메일 발송으로 개인정보를 보호합니다</p>
      </div>
      
      <!-- 로그인 상태 표시 -->
      <div id="auth-status" class="mb-8 audionyx-card rounded-2xl p-6">
        <div id="logged-out" class="text-center">
          <div class="mb-6">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full glass-effect flex items-center justify-center">
              <span class="text-3xl">🔐</span>
            </div>
            <h3 class="text-lg font-semibold mb-2" style="color: var(--color-text-light);">관리자 인증 필요</h3>
            <p class="text-sm mb-6" style="color: var(--color-text-gray);">메일을 발송하려면 먼저 로그인하세요.</p>
          </div>
          <button id="login-btn" class="audionyx-btn-primary px-8 py-3 rounded-xl font-semibold inline-flex items-center gap-2">
            <span class="text-lg">🔑</span>
            Google 로그인
          </button>
        </div>
        <div id="logged-in" class="hidden">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center">
                <span class="text-lg">👤</span>
              </div>
              <div>
                <span id="user-info" class="font-semibold" style="color: var(--color-text-light);"></span>
                <p class="text-xs" style="color: var(--color-text-gray);">관리자 권한으로 로그인됨</p>
              </div>
            </div>
            <button id="logout-btn" class="audionyx-btn-secondary px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              로그아웃
            </button>
          </div>
        </div>
      </div>

      <!-- 메일 발송 폼 -->
      <div id="mail-form-container" class="hidden">
        <form id="mail-form" class="space-y-8 audionyx-card rounded-2xl p-8">
          <!-- 받는 사람 이메일 섹션 -->
          <div>
            <div class="flex items-center gap-2 mb-4">
              <span class="text-lg">📮</span>
              <label class="block text-lg font-semibold" style="color: var(--color-text-light);">받는 사람 이메일</label>
            </div>
            
            <!-- 입력 방식 선택 탭 -->
            <div class="flex mb-6 glass-effect rounded-xl p-1.5">
              <button 
                type="button" 
                id="tab-individual" 
                class="audionyx-tab-active flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all"
              >
                <span class="mr-2">📝</span>개별 추가
              </button>
              <button 
                type="button" 
                id="tab-bulk" 
                class="audionyx-tab-inactive flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all"
              >
                <span class="mr-2">📋</span>일괄 입력
              </button>
            </div>

            <!-- 개별 추가 방식 -->
            <div id="individual-mode">
              <div class="space-y-3 mb-4" id="email-list">
                <div class="flex gap-3 email-item">
                  <input 
                    type="email" 
                    class="audionyx-input flex-1 p-4 rounded-xl font-medium email-input" 
                    placeholder="recipient@example.com"
                  />
                  <button 
                    type="button" 
                    class="audionyx-btn-secondary px-4 py-4 rounded-xl transition-all remove-email hover:bg-red-500 hover:border-red-500"
                    title="이메일 제거"
                  >
                    <span class="text-lg">🗑️</span>
                  </button>
                </div>
              </div>
              <button 
                type="button" 
                id="add-email" 
                class="audionyx-btn-secondary w-full py-3 rounded-xl font-medium transition-all inline-flex items-center justify-center gap-2"
              >
                <span class="text-lg">➕</span>
                이메일 추가
              </button>
              <div class="mt-4 p-4 glass-effect rounded-xl">
                <div class="flex items-start gap-2 text-sm" style="color: var(--color-text-gray);">
                  <span class="text-base">💡</span>
                  <span>각 이메일 주소를 개별적으로 추가하고 관리할 수 있습니다.</span>
                </div>
              </div>
            </div>

            <!-- 일괄 입력 방식 -->
            <div id="bulk-mode" class="hidden">
              <textarea 
                id="bulk-emails" 
                rows="6"
                class="audionyx-input w-full p-4 rounded-xl font-medium" 
                placeholder="여러 이메일 주소를 입력하세요. 쉼표(,), 세미콜론(;) 또는 줄바꿈으로 구분해주세요.&#10;&#10;예시:&#10;user1@example.com, user2@example.com&#10;user3@example.com"
              ></textarea>
              <div class="mt-4 p-4 glass-effect rounded-xl">
                <div class="flex items-start gap-2 text-sm" style="color: var(--color-text-gray);">
                  <span class="text-base">💡</span>
                  <span>쉼표(,), 세미콜론(;) 또는 줄바꿈으로 여러 이메일을 구분해주세요.</span>
                </div>
              </div>
            </div>

            <!-- 이메일 개수 표시 -->
            <div class="mt-6 p-4 audionyx-gradient-border rounded-xl">
              <div class="relative z-10">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">📧</span>
                  <span class="font-semibold" style="color: var(--color-text-light);">
                    발송 대상: <span id="email-count-number" class="font-bold" style="color: var(--color-primary);">1</span>개 이메일
                  </span>
                </div>
                <div class="flex items-center gap-2 text-sm" style="color: var(--color-text-gray);">
                  <span>🔒</span>
                  <span>개인정보 보호: 각 수신자는 다른 수신자의 이메일 주소를 볼 수 없습니다 (1대1 개별 발송)</span>
                </div>
            </div>
            </div>
          </div>
          
          <!-- 제목 입력 -->
          <div>
            <div class="flex items-center gap-2 mb-4">
              <span class="text-lg">📝</span>
              <label for="subject" class="block text-lg font-semibold" style="color: var(--color-text-light);">메일 제목</label>
            </div>
            <input 
              id="subject" 
              type="text" 
              class="audionyx-input w-full p-4 rounded-xl font-medium" 
              placeholder="메일 제목을 입력하세요"
              required
            />
          </div>
          
          <!-- 메일 내용 입력 -->
          <div>
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <span class="text-lg">💌</span>
                <label for="html" class="block text-lg font-semibold" style="color: var(--color-text-light);">메일 내용 (HTML)</label>
              </div>
              <!-- 템플릿 버튼 영역 -->
              <div class="flex gap-2">
                <button 
                  type="button" 
                  id="tpl-jp-coldmail"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="일본 크리에이터 콜드 메일 템플릿 삽입"
                >
                  <span>🇯🇵</span>
                  일본 콜드메일
                </button>
                <button 
                  type="button" 
                  id="tpl-kr-coldmail"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="한국 크리에이터 콜드 메일 템플릿 삽입"
                >
                  <span>🇰🇷</span>
                  한국 콜드메일
                </button>
                <!-- 향후 템플릿 확장 자리: 자동 루프 생성 예정 -->
              </div>
            </div>
            <textarea 
              id="html" 
              rows="14"
              class="audionyx-input w-full p-4 rounded-xl font-mono text-sm leading-relaxed" 
              placeholder="<h1>안녕하세요!</h1><p>메일 본문을 HTML로 작성하세요.</p>"
              required
            ></textarea>
          </div>
          
          <!-- 발송 버튼 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
            <button 
              type="submit" 
              class="audionyx-btn-primary p-4 rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-3"
              id="send-btn"
            >
              <span class="text-xl">📨</span>
              <span>개별 메일 발송 (1대1)</span>
            </button>
            <button 
              type="button" 
              id="preview-btn"
              class="audionyx-btn-secondary p-4 rounded-xl font-semibold transition-all inline-flex items-center justify-center gap-3"
            >
              <span class="text-xl">👁️</span>
              <span>미리보기</span>
            </button>
          </div>
        </form>
      </div>

      <!-- 미리보기 모달 -->
      <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="audionyx-card max-w-5xl overflow-hidden rounded-2xl m-6 flex flex-col" style="max-height: 90vh;">
          <div class="flex justify-between items-center p-6 border-b border-gray-700 flex-shrink-0">
            <div class="flex items-center gap-2">
              <span class="text-lg">👁️</span>
              <h3 class="text-xl font-semibold" style="color: var(--color-text-light);">메일 미리보기</h3>
            </div>
            <button id="close-preview" class="audionyx-btn-secondary w-10 h-10 rounded-full flex items-center justify-center text-lg transition-all">
              ✕
            </button>
          </div>
          <div class="p-6 overflow-y-auto flex-1 min-h-0" style="overflow-y: auto; min-height: 0;">
            <div id="preview-content" class="bg-white rounded-xl p-6 text-black min-h-full"></div>
          </div>
        </div>
      </div>

      <!-- 발송 결과 -->
      <div id="result" class="mt-8 p-6 rounded-2xl hidden"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-functions.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyBP926ULg9wNUNGjQy0fMjRxUeS4XyeG6M",
      authDomain: "audionyx-a7b2e.firebaseapp.com",
      projectId: "audionyx-a7b2e",
      storageBucket: "audionyx-a7b2e.firebasestorage.app",
      messagingSenderId: "1002069862376",
      appId: "1:1002069862376:web:669c93bca8ab2f1d09665d",
      measurementId: "G-P6GNNYLJ38"
    };

    const app = initializeApp(firebaseConfig);
    const functions = getFunctions(app);
    const auth = getAuth(app);

    // DOM 요소들
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const loggedOut = document.getElementById("logged-out");
    const loggedIn = document.getElementById("logged-in");
    const userInfo = document.getElementById("user-info");
    const mailFormContainer = document.getElementById("mail-form-container");
    const mailForm = document.getElementById("mail-form");
    const sendBtn = document.getElementById("send-btn");
    const previewBtn = document.getElementById("preview-btn");
    const previewModal = document.getElementById("preview-modal");
    const previewContent = document.getElementById("preview-content");
    const closePreview = document.getElementById("close-preview");
    const result = document.getElementById("result");
    const htmlTextarea = document.getElementById("html");
    const tplBtnJpColdmail = document.getElementById("tpl-jp-coldmail");
    const tplBtnKrColdmail = document.getElementById("tpl-kr-coldmail");

    // 템플릿 정의 (향후 확장 가능 구조)
    const mailTemplates = [
      { id: "jp-coldmail", label: "🇯🇵 일본 콜드메일 템플릿", path: "/japan-creator-coldmail.html" },
      { id: "kr-coldmail", label: "🇰🇷 한국 콜드메일 템플릿", path: "/korea-creator-coldmail.html" }
    ];

    // 새로운 이메일 관련 DOM 요소들
    const tabIndividual = document.getElementById("tab-individual");
    const tabBulk = document.getElementById("tab-bulk");
    const individualMode = document.getElementById("individual-mode");
    const bulkMode = document.getElementById("bulk-mode");
    const emailList = document.getElementById("email-list");
    const addEmailBtn = document.getElementById("add-email");
    const bulkEmails = document.getElementById("bulk-emails");
    const emailCountNumber = document.getElementById("email-count-number");

    // 이메일 유효성 검증 함수
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email.trim());
    }

    // 이메일 개수 업데이트 함수
    function updateEmailCount() {
      const emails = getAllEmails();
      emailCountNumber.textContent = emails.length;
      // 중복 제거로 인해 실제 전송 대상 수 표시가 변경될 수 있으므로, 안내 메시지를 업데이트하려면 이 지점에서 후속 UI 업데이트 가능
    }

    // 모든 이메일 주소 수집 함수 (중복 제거 포함)
    function getAllEmails() {
      const seen = new Set();
      const result = [];

      if (individualMode.classList.contains("hidden")) {
        // 일괄 입력 모드
        const bulkText = bulkEmails.value.trim();
        if (!bulkText) return [];

        const parsed = bulkText
          .split(/[,;\n]/)
          .map(email => email.trim())
          .filter(email => email && isValidEmail(email));

        for (const email of parsed) {
          const key = email.toLowerCase();
          if (!seen.has(key)) {
            seen.add(key);
            result.push(email);
          }
        }
      } else {
        // 개별 추가 모드
        const emailInputs = emailList.querySelectorAll(".email-input");
        emailInputs.forEach(input => {
          const email = input.value.trim();
          if (email && isValidEmail(email)) {
            const key = email.toLowerCase();
            if (!seen.has(key)) {
              seen.add(key);
              result.push(email);
            }
          }
        });
      }

      return result;
    }

    // 이메일 아이템 생성 함수
    function createEmailItem() {
      const emailItem = document.createElement("div");
      emailItem.className = "flex gap-3 email-item";
      emailItem.innerHTML = `
        <input 
          type="email" 
          class="audionyx-input flex-1 p-4 rounded-xl font-medium email-input" 
          placeholder="recipient@example.com"
        />
        <button 
          type="button" 
          class="audionyx-btn-secondary px-4 py-4 rounded-xl transition-all remove-email hover:bg-red-500 hover:border-red-500"
          title="이메일 제거"
        >
          <span class="text-lg">🗑️</span>
        </button>
      `;

      // 이메일 입력 시 개수 업데이트
      const emailInput = emailItem.querySelector(".email-input");
      emailInput.addEventListener("input", updateEmailCount);

      // 제거 버튼 이벤트
      const removeBtn = emailItem.querySelector(".remove-email");
      removeBtn.addEventListener("click", () => {
        if (emailList.children.length > 1) {
          emailItem.remove();
          updateEmailCount();
        }
      });

      return emailItem;
    }

    // 탭 전환 함수
    function switchTab(mode) {
      if (mode === "individual") {
        tabIndividual.className = "audionyx-tab-active flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        tabBulk.className = "audionyx-tab-inactive flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        
        individualMode.classList.remove("hidden");
        bulkMode.classList.add("hidden");
      } else {
        tabBulk.className = "audionyx-tab-active flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        tabIndividual.className = "audionyx-tab-inactive flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        
        bulkMode.classList.remove("hidden");
        individualMode.classList.add("hidden");
      }
      updateEmailCount();
    }

    // 이벤트 리스너들
    tabIndividual.addEventListener("click", () => switchTab("individual"));
    tabBulk.addEventListener("click", () => switchTab("bulk"));

    // 이메일 추가 버튼
    addEmailBtn.addEventListener("click", () => {
      const newEmailItem = createEmailItem();
      emailList.appendChild(newEmailItem);
      newEmailItem.querySelector(".email-input").focus();
      updateEmailCount();
    });

    // 일괄 입력 텍스트 변경 시 개수 업데이트
    bulkEmails.addEventListener("input", updateEmailCount);

    // 초기 이메일 입력 필드에 이벤트 추가
    document.querySelector(".email-input").addEventListener("input", updateEmailCount);
    document.querySelector(".remove-email").addEventListener("click", (e) => {
      if (emailList.children.length > 1) {
        e.target.closest(".email-item").remove();
        updateEmailCount();
      }
    });

    // 템플릿 로더: 파일을 불러와 textarea에 삽입
    async function loadTemplateIntoEditor(templatePath) {
      try {
        const res = await fetch(templatePath, { cache: "no-cache" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const htmlText = await res.text();
        htmlTextarea.value = htmlText;
        showResult("✅ 템플릿이 본문에 삽입되었습니다.", "success");
      } catch (err) {
        console.error("템플릿 로드 실패:", err);
        showResult("❌ 템플릿 로드 중 오류가 발생했습니다.", "error");
      }
    }

    // 단일 버튼 바인딩 (향후 루프로 일반화 가능)
    tplBtnJpColdmail.addEventListener("click", () => {
      loadTemplateIntoEditor("/japan-creator-coldmail.html");
    });
    tplBtnKrColdmail.addEventListener("click", () => {
      loadTemplateIntoEditor("/korea-creator-coldmail.html");
    });

    // 인증 상태 변경 감지
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loggedOut.classList.add("hidden");
        loggedIn.classList.remove("hidden");
        mailFormContainer.classList.remove("hidden");
        userInfo.textContent = `👤 ${user.displayName || user.email}`;
      } else {
        loggedOut.classList.remove("hidden");
        loggedIn.classList.add("hidden");
        mailFormContainer.classList.add("hidden");
      }
    });

    // 로그인
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch (error) {
        console.error("로그인 오류:", error);
        showResult("로그인에 실패했습니다.", "error");
      }
    });

    // 로그아웃
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error("로그아웃 오류:", error);
      }
    });

    // 미리보기
    previewBtn.addEventListener("click", () => {
      const html = document.getElementById("html").value;
      previewContent.innerHTML = html;
      previewModal.classList.remove("hidden");
    });

    closePreview.addEventListener("click", () => {
      previewModal.classList.add("hidden");
    });

    // 메일 발송
    mailForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const emails = getAllEmails();
      const subject = document.getElementById("subject").value.trim();
      const html = document.getElementById("html").value;

      // 유효성 검증
      if (emails.length === 0) {
        showResult("❌ 유효한 이메일 주소를 하나 이상 입력해주세요.", "error");
        return;
      }

      if (!subject || !html) {
        showResult("❌ 제목과 메일 내용을 입력해주세요.", "error");
        return;
      }

      // 인증 상태 확인
      const currentUser = auth.currentUser;
      if (!currentUser) {
        showResult("❌ 로그인이 필요합니다.", "error");
        return;
      }

      console.log("발송 대상 이메일:", emails);
      console.log("이메일 개수:", emails.length);

      sendBtn.disabled = true;
      sendBtn.textContent = `📨 ${emails.length}개 이메일로 개별 발송 중...`;

      try {
        const sendMail = httpsCallable(functions, "sendMail");
        let sentCount = 0;
        const sentEmails = [];
        const failedEmails = [];

        // 각 이메일 주소로 개별 발송 (1대1 발송으로 처리)
        for (let i = 0; i < emails.length; i++) {
          const email = emails[i];
          
          try {
            // 진행 상황 표시
            sendBtn.textContent = `📨 발송 중... (${i + 1}/${emails.length})`;
            
            const mailData = { 
              to: email, // 단일 이메일로 개별 발송
              subject, 
              html 
            };
            
            const result = await sendMail(mailData);
            console.log(`이메일 발송 성공: ${email}`, result);
            
            sentCount++;
            sentEmails.push(email);
            
            // 발송 간격 조정 (rate limiting 방지)
            if (i < emails.length - 1) {
              await new Promise(resolve => setTimeout(resolve, 500)); // 0.5초 대기
            }
            
          } catch (emailError) {
            console.error(`이메일 발송 실패: ${email}`, emailError);
            failedEmails.push({ email, error: emailError.message });
          }
        }
        
        // 발송 결과 처리
        if (sentCount === emails.length) {
          // 모든 이메일 발송 성공
          showResult(
            `✅ 개별 메일 발송이 성공적으로 완료되었습니다!\n` +
            `📧 발송 완료: ${sentCount}개 이메일 (각각 1대1 개별 발송)\n` +
            `📋 수신자: ${sentEmails.slice(0, 3).join(", ")}${sentEmails.length > 3 ? ` 외 ${sentEmails.length - 3}명` : ""}`, 
            "success"
          );
        } else if (sentCount > 0) {
          // 일부 발송 성공
          showResult(
            `⚠️ 일부 메일 발송이 완료되었습니다.\n` +
            `✅ 성공: ${sentCount}개 이메일\n` +
            `❌ 실패: ${failedEmails.length}개 이메일\n` +
            `📋 성공 수신자: ${sentEmails.slice(0, 2).join(", ")}${sentEmails.length > 2 ? ` 외 ${sentEmails.length - 2}명` : ""}\n` +
            `💥 실패 수신자: ${failedEmails.slice(0, 2).map(f => f.email).join(", ")}${failedEmails.length > 2 ? ` 외 ${failedEmails.length - 2}명` : ""}`, 
            "warning"
          );
        } else {
          // 모든 발송 실패
          showResult(
            `❌ 모든 메일 발송이 실패했습니다.\n` +
            `💥 실패 수신자: ${failedEmails.slice(0, 3).map(f => f.email).join(", ")}${failedEmails.length > 3 ? ` 외 ${failedEmails.length - 3}명` : ""}\n` +
            `💬 주요 오류: ${failedEmails[0]?.error || "알 수 없는 오류"}`, 
            "error"
          );
        }
        
        // 폼 초기화
        mailForm.reset();
        
        // 개별 추가 모드라면 이메일 목록도 초기화
        if (!individualMode.classList.contains("hidden")) {
          emailList.innerHTML = `
            <div class="flex gap-3 email-item">
              <input 
                type="email" 
                class="audionyx-input flex-1 p-4 rounded-xl font-medium email-input" 
                placeholder="recipient@example.com"
              />
              <button 
                type="button" 
                class="audionyx-btn-secondary px-4 py-4 rounded-xl transition-all remove-email hover:bg-red-500 hover:border-red-500"
                title="이메일 제거"
              >
                <span class="text-lg">🗑️</span>
              </button>
            </div>
          `;
          // 이벤트 리스너 다시 추가
          document.querySelector(".email-input").addEventListener("input", updateEmailCount);
          document.querySelector(".remove-email").addEventListener("click", (e) => {
            if (emailList.children.length > 1) {
              e.target.closest(".email-item").remove();
              updateEmailCount();
            }
          });
        }
        
        updateEmailCount();
        
      } catch (error) {
        console.error("메일 발송 오류:", error);
        console.error("오류 상세:", {
          code: error.code,
          message: error.message,
          details: error.details
        });
        showResult(
          `❌ 메일 발송에 실패했습니다.\n` +
          `💬 오류 메시지: ${error.message}\n` +
          `🎯 대상 이메일: ${emails.length}개`, 
          "error"
        );
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "📨 개별 메일 발송 (1대1)";
      }
    });

    // 결과 표시
    function showResult(message, type) {
      let bgClass, icon;
      
      switch(type) {
        case "success":
          bgClass = "audionyx-success";
          icon = "✅";
          break;
        case "warning":
          bgClass = "audionyx-warning";
          icon = "⚠️";
          break;
        case "error":
        default:
          bgClass = "audionyx-error";
          icon = "❌";
          break;
      }
      
      result.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="text-2xl">${icon}</span>
          <div class="flex-1">
            <pre class="whitespace-pre-wrap font-sans leading-relaxed">${message}</pre>
          </div>
        </div>
      `;
      
      result.className = `mt-8 p-6 rounded-2xl ${bgClass}`;
      result.classList.remove("hidden");
      
      // warning이나 error인 경우 더 오래 표시
      const displayTime = type === "error" || type === "warning" ? 8000 : 5000;
      
      setTimeout(() => {
        result.classList.add("hidden");
      }, displayTime);
    }

    // 모달 외부 클릭시 닫기
    previewModal.addEventListener("click", (e) => {
      if (e.target === previewModal) {
        previewModal.classList.add("hidden");
      }
    });
  </script>
</body>
</html> 