<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>메일 발송 - Audionyx</title>
  <link href="https://unpkg.com/tailwindcss@2/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #3EB489;
      --color-primary-hover: #2A9D74;
      --color-accent: #A8E6CE;
      --color-neutral-dark: #0C0C0C;
      --color-surface: #FFFFFF;
      --color-border: #2A9D74;
      --color-text-light: #F0FFF0;
      --color-text-gray: #A7D3C9;
      --dark-bg: #000000;
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
      --radius-lg: 16px;
      --radius-md: 8px;
      --font-primary: 'Inter', 'Pretendard', sans-serif;
    }
    
    body {
      font-family: var(--font-primary);
      background: linear-gradient(135deg, #000000 0%, #0A0A0A 100%);
      color: var(--color-text-light);
    }
    
    .audionyx-card {
      background: linear-gradient(145deg, rgba(12, 12, 12, 0.9) 0%, rgba(20, 20, 20, 0.8) 100%);
      border: 1px solid rgba(62, 180, 137, 0.2);
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(10px);
    }
    
    .audionyx-btn-primary {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
      color: var(--color-neutral-dark);
      font-weight: 600;
      border: 1px solid rgba(168, 230, 206, 0.3);
      box-shadow: 0 4px 20px rgba(62, 180, 137, 0.4);
      transition: all 0.3s ease;
    }
    
    .audionyx-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(62, 180, 137, 0.6);
    }
    
    .audionyx-btn-secondary {
      background: rgba(62, 180, 137, 0.1);
      color: var(--color-text-light);
      border: 1px solid rgba(62, 180, 137, 0.3);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .audionyx-btn-secondary:hover {
      background: rgba(62, 180, 137, 0.2);
      border-color: var(--color-primary);
    }
    
    .audionyx-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(62, 180, 137, 0.2);
      color: var(--color-text-light);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .audionyx-input:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(62, 180, 137, 0.2);
      background: rgba(255, 255, 255, 0.08);
    }
    
    .audionyx-input::placeholder {
      color: var(--color-text-gray);
    }
    
    .audionyx-tab-active {
      background: var(--color-primary);
      color: var(--color-neutral-dark);
      box-shadow: 0 4px 12px rgba(62, 180, 137, 0.3);
    }
    
    .audionyx-tab-inactive {
      background: rgba(62, 180, 137, 0.1);
      color: var(--color-text-gray);
      border: 1px solid rgba(62, 180, 137, 0.2);
    }
    
    .audionyx-tab-inactive:hover {
      background: rgba(62, 180, 137, 0.15);
      color: var(--color-text-light);
    }
    
    .audionyx-success {
      background: linear-gradient(135deg, rgba(62, 180, 137, 0.2) 0%, rgba(42, 157, 116, 0.1) 100%);
      border: 1px solid rgba(62, 180, 137, 0.4);
      color: var(--color-accent);
    }
    
    .audionyx-warning {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 193, 7, 0.1) 100%);
      border: 1px solid rgba(255, 193, 7, 0.4);
      color: #FFE082;
    }
    
    .audionyx-error {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.2) 0%, rgba(244, 67, 54, 0.1) 100%);
      border: 1px solid rgba(244, 67, 54, 0.4);
      color: #FFCDD2;
    }
    
    .audionyx-gradient-border {
      position: relative;
      background: linear-gradient(145deg, rgba(12, 12, 12, 0.9) 0%, rgba(20, 20, 20, 0.8) 100%);
    }
    
    .audionyx-gradient-border::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: subtract;
      -webkit-mask-composite: xor;
    }
    
    .glass-effect {
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-6 py-12">
    <div class="max-w-5xl mx-auto">
      <!-- 헤더 섹션 -->
      <div class="text-center mb-12">
        <div class="inline-flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center">
            <span class="text-2xl">📧</span>
          </div>
          <h1 class="text-4xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
            AUDIONYX
          </h1>
        </div>
        <p class="text-xl font-semibold mb-2" style="color: var(--color-text-light);">관리자 메일 발송 시스템</p>
        <p class="text-sm opacity-75" style="color: var(--color-text-gray);">개별 1대1 메일 발송으로 개인정보를 보호합니다</p>
      </div>
      
      <!-- 로그인 상태 표시 -->
      <div id="auth-status" class="mb-8 audionyx-card rounded-2xl p-6">
        <div id="logged-out" class="text-center">
          <div class="mb-6">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full glass-effect flex items-center justify-center">
              <span class="text-3xl">🔐</span>
            </div>
            <h3 class="text-lg font-semibold mb-2" style="color: var(--color-text-light);">관리자 인증 필요</h3>
            <p class="text-sm mb-6" style="color: var(--color-text-gray);">메일을 발송하려면 먼저 로그인하세요.</p>
          </div>
          <button id="login-btn" class="audionyx-btn-primary px-8 py-3 rounded-xl font-semibold inline-flex items-center gap-2">
            <span class="text-lg">🔑</span>
            Google 로그인
          </button>
        </div>
        <div id="logged-in" class="hidden">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center">
                <span class="text-lg">👤</span>
              </div>
              <div>
                <span id="user-info" class="font-semibold" style="color: var(--color-text-light);"></span>
                <p class="text-xs" style="color: var(--color-text-gray);">관리자 권한으로 로그인됨</p>
              </div>
            </div>
            <button id="logout-btn" class="audionyx-btn-secondary px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              로그아웃
            </button>
          </div>
        </div>
      </div>

      <!-- 메일 발송 폼 -->
      <div id="mail-form-container" class="hidden">
        <form id="mail-form" class="space-y-8 audionyx-card rounded-2xl p-8">
          <!-- 받는 사람 이메일 섹션 -->
          <div>
            <div class="flex items-center gap-2 mb-4">
              <span class="text-lg">📮</span>
              <label class="block text-lg font-semibold" style="color: var(--color-text-light);">받는 사람 이메일</label>
            </div>
            
            <!-- 입력 방식 선택 탭 -->
            <div class="flex mb-6 glass-effect rounded-xl p-1.5">
              <button 
                type="button" 
                id="tab-individual" 
                class="audionyx-tab-active flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all"
              >
                <span class="mr-2">📝</span>개별 추가
              </button>
              <button 
                type="button" 
                id="tab-bulk" 
                class="audionyx-tab-inactive flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all"
              >
                <span class="mr-2">📋</span>일괄 입력
              </button>
            </div>

            <!-- 개별 추가 방식 -->
            <div id="individual-mode">
              <div class="space-y-3 mb-4" id="email-list">
                <div class="flex gap-3 email-item">
                  <input 
                    type="email" 
                    class="audionyx-input flex-1 p-4 rounded-xl font-medium email-input" 
                    placeholder="recipient@example.com"
                  />
                  <button 
                    type="button" 
                    class="audionyx-btn-secondary px-4 py-4 rounded-xl transition-all remove-email hover:bg-red-500 hover:border-red-500"
                    title="이메일 제거"
                  >
                    <span class="text-lg">🗑️</span>
                  </button>
                </div>
              </div>
              <button 
                type="button" 
                id="add-email" 
                class="audionyx-btn-secondary w-full py-3 rounded-xl font-medium transition-all inline-flex items-center justify-center gap-2"
              >
                <span class="text-lg">➕</span>
                이메일 추가
              </button>
              <div class="mt-4 p-4 glass-effect rounded-xl">
                <div class="flex items-start gap-2 text-sm" style="color: var(--color-text-gray);">
                  <span class="text-base">💡</span>
                  <span>각 이메일 주소를 개별적으로 추가하고 관리할 수 있습니다.</span>
                </div>
              </div>
            </div>

            <!-- 일괄 입력 방식 -->
            <div id="bulk-mode" class="hidden">
              <textarea 
                id="bulk-emails" 
                rows="6"
                class="audionyx-input w-full p-4 rounded-xl font-medium" 
                placeholder="여러 이메일 주소를 입력하세요. 쉼표(,), 세미콜론(;) 또는 줄바꿈으로 구분해주세요.&#10;&#10;예시:&#10;user1@example.com, user2@example.com&#10;user3@example.com"
              ></textarea>
              <div class="mt-4 p-4 glass-effect rounded-xl">
                <div class="flex items-start gap-2 text-sm" style="color: var(--color-text-gray);">
                  <span class="text-base">💡</span>
                  <span>쉼표(,), 세미콜론(;) 또는 줄바꿈으로 여러 이메일을 구분해주세요.</span>
                </div>
              </div>
            </div>

            <!-- 이메일 개수 표시 -->
            <div class="mt-6 p-4 audionyx-gradient-border rounded-xl">
              <div class="relative z-10">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">📧</span>
                  <span class="font-semibold" style="color: var(--color-text-light);">
                    발송 대상: <span id="email-count-number" class="font-bold" style="color: var(--color-primary);">1</span>개 이메일
                  </span>
                </div>
                <div class="flex items-center gap-2 text-sm" style="color: var(--color-text-gray);">
                  <span>🔒</span>
                  <span>개인정보 보호: 각 수신자는 다른 수신자의 이메일 주소를 볼 수 없습니다 (1대1 개별 발송)</span>
                </div>
            </div>
            </div>
          </div>
          
          <!-- 제목 입력 -->
          <div>
            <div class="flex items-center gap-2 mb-4">
              <span class="text-lg">📝</span>
              <label for="subject" class="block text-lg font-semibold" style="color: var(--color-text-light);">메일 제목</label>
            </div>
            <input 
              id="subject" 
              type="text" 
              class="audionyx-input w-full p-4 rounded-xl font-medium" 
              placeholder="메일 제목을 입력하세요"
              required
            />
          </div>
          
          <!-- 메일 내용 입력 -->
          <div>
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <span class="text-lg">💌</span>
                <label for="html" class="block text-lg font-semibold" style="color: var(--color-text-light);">메일 내용 (HTML)</label>
              </div>
              <!-- 템플릿 버튼 영역 -->
              <div class="flex gap-2">
                <button 
                  type="button" 
                  id="tpl-jp-coldmail"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="일본 크리에이터 콜드 메일 템플릿 삽입"
                >
                  <span>🇯🇵</span>
                  일본 콜드메일
                </button>
                <button 
                  type="button" 
                  id="tpl-kr-coldmail"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="한국 크리에이터 콜드 메일 템플릿 삽입"
                >
                  <span>🇰🇷</span>
                  한국 콜드메일
                </button>
                
                <button 
                  type="button" 
                  id="tpl-track-submitted"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="개인 음원 신청 접수완료 템플릿 삽입"
                >
                  <span>✅</span>
                  접수완료 안내
                </button>
                <button 
                  type="button" 
                  id="tpl-final-confirmation"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="개인 음원 최종 확인 안내 템플릿 생성"
                >
                  <span>🧾</span>
                  최종 확인 안내
                </button>
                <!-- 향후 템플릿 확장 자리: 자동 루프 생성 예정 -->
              </div>
            </div>
            <!-- 개인 음원 최종 확인 입력 패널 (버튼 클릭 시 표시) -->
            <div id="final-confirmation-panel" class="hidden mt-4 p-6 glass-effect rounded-xl space-y-4">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-lg">🧾</span>
                <h4 class="font-semibold" style="color: var(--color-text-light);">개인 음원 최종 확인 — 내용 자동 생성</h4>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="fc-track-title" class="block text-sm mb-2" style="color: var(--color-text-gray);">트랙 제목</label>
                  <input id="fc-track-title" type="text" class="audionyx-input w-full p-3 rounded-xl font-medium" placeholder="예: Sunset Drive" />
                </div>
                <div>
                  <label for="fc-artist-name" class="block text-sm mb-2" style="color: var(--color-text-gray);">아티스트 명</label>
                  <input id="fc-artist-name" type="text" class="audionyx-input w-full p-3 rounded-xl font-medium" placeholder="예: Audionyx" />
                </div>
                <div>
                  <label for="fc-cover-file" class="block text-sm mb-2" style="color: var(--color-text-gray);">커버 이미지 (파일 첨부)</label>
                  <input id="fc-cover-file" type="file" accept="image/*" class="audionyx-input w-full p-3 rounded-xl font-medium" />
                </div>
                <div>
                  <label for="fc-track-file" class="block text-sm mb-2" style="color: var(--color-text-gray);">트랙 파일 (파일 첨부)</label>
                  <input id="fc-track-file" type="file" accept="audio/*" class="audionyx-input w-full p-3 rounded-xl font-medium" />
                </div>
              </div>
              <div class="flex items-center gap-3 pt-2">
                <button type="button" id="final-confirmation-insert" class="audionyx-btn-primary px-5 py-3 rounded-xl text-sm font-semibold inline-flex items-center gap-2">
                  <span>🧩</span>
                  본문에 삽입
                </button>
                <button type="button" id="final-confirmation-cancel" class="audionyx-btn-secondary px-5 py-3 rounded-xl text-sm font-medium inline-flex items-center gap-2">
                  취소/닫기
                </button>
                <div class="text-xs" style="color: var(--color-text-gray);">
                  계좌: <span class="font-semibold" style="color: var(--color-text-light);">하나은행 823-910017-83704</span> (예금주: 주식회사 오디오닉스)
                </div>
              </div>
            </div>
            <textarea 
              id="html" 
              rows="14"
              class="audionyx-input w-full p-4 rounded-xl font-mono text-sm leading-relaxed" 
              placeholder="<h1>안녕하세요!</h1><p>메일 본문을 HTML로 작성하세요.</p>"
              required
            ></textarea>
          </div>
          
          <!-- 발송 버튼 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
            <button 
              type="submit" 
              class="audionyx-btn-primary p-4 rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-3"
              id="send-btn"
            >
              <span class="text-xl">📨</span>
              <span>개별 메일 발송 (1대1)</span>
            </button>
            <button 
              type="button" 
              id="preview-btn"
              class="audionyx-btn-secondary p-4 rounded-xl font-semibold transition-all inline-flex items-center justify-center gap-3"
            >
              <span class="text-xl">👁️</span>
              <span>미리보기</span>
            </button>
          </div>
        </form>
      </div>

      <!-- 미리보기 모달 -->
      <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="audionyx-card max-w-5xl overflow-hidden rounded-2xl m-6 flex flex-col" style="max-height: 90vh;">
          <div class="flex justify-between items-center p-6 border-b border-gray-700 flex-shrink-0">
            <div class="flex items-center gap-2">
              <span class="text-lg">👁️</span>
              <h3 class="text-xl font-semibold" style="color: var(--color-text-light);">메일 미리보기</h3>
            </div>
            <button id="close-preview" class="audionyx-btn-secondary w-10 h-10 rounded-full flex items-center justify-center text-lg transition-all">
              ✕
            </button>
          </div>
          <div class="p-6 overflow-y-auto flex-1 min-h-0" style="overflow-y: auto; min-height: 0;">
            <div id="preview-content" class="bg-white rounded-xl p-6 text-black min-h-full"></div>
          </div>
        </div>
      </div>

      <!-- 발송 결과 -->
      <div id="result" class="mt-8 p-6 rounded-2xl hidden"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-functions.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyBP926ULg9wNUNGjQy0fMjRxUeS4XyeG6M",
      authDomain: "audionyx-a7b2e.firebaseapp.com",
      projectId: "audionyx-a7b2e",
      storageBucket: "audionyx-a7b2e.firebasestorage.app",
      messagingSenderId: "1002069862376",
      appId: "1:1002069862376:web:669c93bca8ab2f1d09665d",
      measurementId: "G-P6GNNYLJ38"
    };

    const app = initializeApp(firebaseConfig);
    const functions = getFunctions(app);
    const auth = getAuth(app);

    // DOM 요소들
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const loggedOut = document.getElementById("logged-out");
    const loggedIn = document.getElementById("logged-in");
    const userInfo = document.getElementById("user-info");
    const mailFormContainer = document.getElementById("mail-form-container");
    const mailForm = document.getElementById("mail-form");
    const sendBtn = document.getElementById("send-btn");
    const previewBtn = document.getElementById("preview-btn");
    const previewModal = document.getElementById("preview-modal");
    const previewContent = document.getElementById("preview-content");
    const closePreview = document.getElementById("close-preview");
    const result = document.getElementById("result");
    const htmlTextarea = document.getElementById("html");
    const tplBtnJpColdmail = document.getElementById("tpl-jp-coldmail");
    const tplBtnKrColdmail = document.getElementById("tpl-kr-coldmail");
    const tplBtnTrackSubmitted = document.getElementById("tpl-track-submitted");
    const tplBtnFinalConfirmation = document.getElementById("tpl-final-confirmation");

    // 템플릿 정의 (향후 확장 가능 구조)
    const mailTemplates = [
      { id: "jp-coldmail", label: "🇯🇵 일본 콜드메일 템플릿", path: "/japan-creator-coldmail.html" },
      { id: "kr-coldmail", label: "🇰🇷 한국 콜드메일 템플릿", path: "/korea-creator-coldmail.html" },
      { id: "track-submitted", label: "✅ 개인 음원 신청 접수완료", path: "/track-request-submitted.html" }
    ];

    // 일반 텍스트 → HTML 변환 유틸 (줄바꿈 보존)
    function isLikelyHtml(input) {
      if (typeof input !== "string") return false;
      return /<\/?[a-z][\s\S]*>/i.test(input);
    }

    function escapeHtml(unsafe) {
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function toHtmlPreserveLineBreaks(input) {
      const value = String(input ?? "");
      if (isLikelyHtml(value)) return value;
      const escaped = escapeHtml(value);
      // 단순 줄바꿈을 <br>로 변환
      return escaped.replace(/\r\n|\r|\n/g, '<br>');
    }

    // 새로운 이메일 관련 DOM 요소들
    const tabIndividual = document.getElementById("tab-individual");
    const tabBulk = document.getElementById("tab-bulk");
    const individualMode = document.getElementById("individual-mode");
    const bulkMode = document.getElementById("bulk-mode");
    const emailList = document.getElementById("email-list");
    const addEmailBtn = document.getElementById("add-email");
    const bulkEmails = document.getElementById("bulk-emails");
    const emailCountNumber = document.getElementById("email-count-number");
    // 최종 확인 템플릿 전용 요소
    const finalPanel = document.getElementById("final-confirmation-panel");
    const fcTrackTitle = document.getElementById("fc-track-title");
    const fcArtistName = document.getElementById("fc-artist-name");
    const fcCoverFile = document.getElementById("fc-cover-file");
    const fcTrackFile = document.getElementById("fc-track-file");
    const fcInsertBtn = document.getElementById("final-confirmation-insert");
    const fcCancelBtn = document.getElementById("final-confirmation-cancel");

    // 이메일 유효성 검증 함수
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email.trim());
    }

    // 이메일 개수 업데이트 함수
    function updateEmailCount() {
      const emails = getAllEmails();
      emailCountNumber.textContent = emails.length;
      // 중복 제거로 인해 실제 전송 대상 수 표시가 변경될 수 있으므로, 안내 메시지를 업데이트하려면 이 지점에서 후속 UI 업데이트 가능
    }

    // 모든 이메일 주소 수집 함수 (중복 제거 포함)
    function getAllEmails() {
      const seen = new Set();
      const result = [];

      if (individualMode.classList.contains("hidden")) {
        // 일괄 입력 모드
        const bulkText = bulkEmails.value.trim();
        if (!bulkText) return [];

        const parsed = bulkText
          .split(/[,;\n]/)
          .map(email => email.trim())
          .filter(email => email && isValidEmail(email));

        for (const email of parsed) {
          const key = email.toLowerCase();
          if (!seen.has(key)) {
            seen.add(key);
            result.push(email);
          }
        }
      } else {
        // 개별 추가 모드
        const emailInputs = emailList.querySelectorAll(".email-input");
        emailInputs.forEach(input => {
          const email = input.value.trim();
          if (email && isValidEmail(email)) {
            const key = email.toLowerCase();
            if (!seen.has(key)) {
              seen.add(key);
              result.push(email);
            }
          }
        });
      }

      return result;
    }

    // 이메일 아이템 생성 함수
    function createEmailItem() {
      const emailItem = document.createElement("div");
      emailItem.className = "flex gap-3 email-item";
      emailItem.innerHTML = `
        <input 
          type="email" 
          class="audionyx-input flex-1 p-4 rounded-xl font-medium email-input" 
          placeholder="recipient@example.com"
        />
        <button 
          type="button" 
          class="audionyx-btn-secondary px-4 py-4 rounded-xl transition-all remove-email hover:bg-red-500 hover:border-red-500"
          title="이메일 제거"
        >
          <span class="text-lg">🗑️</span>
        </button>
      `;

      // 이메일 입력 시 개수 업데이트
      const emailInput = emailItem.querySelector(".email-input");
      emailInput.addEventListener("input", updateEmailCount);

      // 제거 버튼 이벤트
      const removeBtn = emailItem.querySelector(".remove-email");
      removeBtn.addEventListener("click", () => {
        if (emailList.children.length > 1) {
          emailItem.remove();
          updateEmailCount();
        }
      });

      return emailItem;
    }

    // 탭 전환 함수
    function switchTab(mode) {
      if (mode === "individual") {
        tabIndividual.className = "audionyx-tab-active flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        tabBulk.className = "audionyx-tab-inactive flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        
        individualMode.classList.remove("hidden");
        bulkMode.classList.add("hidden");
      } else {
        tabBulk.className = "audionyx-tab-active flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        tabIndividual.className = "audionyx-tab-inactive flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        
        bulkMode.classList.remove("hidden");
        individualMode.classList.add("hidden");
      }
      updateEmailCount();
    }

    // 이벤트 리스너들
    tabIndividual.addEventListener("click", () => switchTab("individual"));
    tabBulk.addEventListener("click", () => switchTab("bulk"));

    // 이메일 추가 버튼
    addEmailBtn.addEventListener("click", () => {
      const newEmailItem = createEmailItem();
      emailList.appendChild(newEmailItem);
      newEmailItem.querySelector(".email-input").focus();
      updateEmailCount();
    });

    // 일괄 입력 텍스트 변경 시 개수 업데이트
    bulkEmails.addEventListener("input", updateEmailCount);

    // 초기 이메일 입력 필드에 이벤트 추가
    document.querySelector(".email-input").addEventListener("input", updateEmailCount);
    document.querySelector(".remove-email").addEventListener("click", (e) => {
      if (emailList.children.length > 1) {
        e.target.closest(".email-item").remove();
        updateEmailCount();
      }
    });

    // 템플릿 로더: 파일을 불러와 textarea에 삽입
    async function loadTemplateIntoEditor(templatePath, subjectToSet) {
      try {
        const res = await fetch(templatePath, { cache: "no-cache" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const htmlText = await res.text();
        htmlTextarea.value = htmlText;
        if (typeof subjectToSet === "string" && subjectToSet.trim().length > 0) {
          const subjectInput = document.getElementById("subject");
          subjectInput.value = subjectToSet;
        }
        showResult("✅ 템플릿이 본문에 삽입되었습니다.", "success");
      } catch (err) {
        console.error("템플릿 로드 실패:", err);
        showResult("❌ 템플릿 로드 중 오류가 발생했습니다.", "error");
      }
    }

    // 개인 음원 최종 확인 — HTML 생성기
    function generateFinalConfirmationHtml({ trackTitle, artistName, coverFileName, trackFileName }) {
      const accountNumber = "하나은행 823-910017-83704";
      const accountHolder = "주식회사 오디오닉스";
      const depositAmount = 49000; // 잔금
      const fmt = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return `
<div style="font-family: 'Inter', 'Apple SD Gothic Neo', 'Malgun Gothic', Arial, sans-serif; background:#f6fbf9; padding:24px;">
  <div style="max-width:720px; margin:0 auto; background:#ffffff; border:1px solid #d9efe7; border-radius:12px; overflow:hidden;">
    <div style="background:linear-gradient(135deg,#3EB489,#2A9D74); color:#0b1f17; padding:18px 22px;">
      <div style="font-weight:700; font-size:18px; color:#052d23;">Audionyx • 개인 음원 최종 확인</div>
      <div style="font-size:12px; color:#083b2d; opacity:0.9; margin-top:2px;">Thank you for creating with us</div>
    </div>

    <div style="padding:24px 22px 8px; color:#0e1412; line-height:1.7;">
      <p style="margin:0 0 14px;">안녕하세요, Audionyx를 믿고 맡겨 주셔서 진심으로 감사드립니다.<br>접수 완료 메일에서 안내드린 흐름에 따라 아래 내용을 마지막으로 확인해 주세요. <strong>잔금 입금이 확인되는 즉시</strong> 유통 준비를 바로 시작하겠습니다.</p>

      <div style="font-weight:700; font-size:16px; margin:18px 0 8px; color:#0e1412;">[1] 최종 확인 항목</div>
      <ul style="padding-left:18px; margin:0 0 12px;">
        <li><strong>트랙 제목:</strong> ${trackTitle}</li>
        <li><strong>아티스트 표기:</strong> ${artistName}</li>
        <li><strong>커버 이미지:</strong> 첨부 (${coverFileName})</li>
        <li><strong>트랙 파일(최종본):</strong> 첨부 (${trackFileName})</li>
      </ul>

      <div style="border:1px solid #c8eadf; background:#eff9f5; border-radius:10px; padding:14px 16px; margin:14px 0;">
        <div style="font-weight:700; color:#0d2f25; margin-bottom:6px;">[2] 잔금 및 확정 안내</div>
        <div style="margin:4px 0;"><strong>입금 금액(잔금):</strong> ${fmt(depositAmount)}원</div>
        <div style="margin:4px 0;"><strong>입금 계좌:</strong> ${accountNumber} <span style="color:#2a7a62;">(예금주: ${accountHolder})</span></div>
        <div style="margin:4px 0;">회신 절차는 필요 없습니다. <strong>잔금 입금이 확인되는 즉시</strong> 유통을 시작하며, 공식 사이트 <strong>음원 신청</strong> 페이지 하단 <strong>내 요청 목록</strong>의 상태 뱃지가 <strong>‘유통 대기’ → ‘유통중’</strong>으로 자동 변경됩니다.</div>
        <div style="margin:6px 0 0; color:#0d2f25;">유통 시작 후 마무리까지는 평균 2주 소요됩니다 (플랫폼 심사 포함).</div>
      </div>

      <div style="border:1px solid #d9efe7; background:#f7fbfa; border-radius:10px; padding:14px 16px; margin:14px 0;">
        <div style="font-weight:700; color:#0d2f25; margin-bottom:6px;">[3] 고객지원 안내</div>
        <div style="margin:4px 0;">진행 중 궁금하신 점이 있으시면 언제든지 <strong>오디오닉스 고객지원팀</strong>으로 연락 주세요. 친절하고 신속하게 도와드리겠습니다.</div>
        <div style="margin:4px 0;">입금 확인이 필요하시다면 <strong>채널톡</strong>으로 문의해 주세요. 사이트 접속 후 우측 하단 말풍선 아이콘을 통해 바로 연결됩니다.</div>
        <div style="margin:4px 0;"><a href="https://audio-nyx.com?chat=open" style="color:#2A9D74; text-decoration:none;">채널톡으로 문의하기</a></div>
        <div style="margin:4px 0;"><strong>이메일:</strong> <a href="mailto:audionyx369@gmail.com" style="color:#2A9D74; text-decoration:none;">audionyx369@gmail.com</a></div>
        <div style="margin:4px 0; color:#0d2f25;">운영 시간: 평일 10:00–18:00 (점심 12:30–13:30)</div>
      </div>

      <p style="margin:14px 0; color:#0e1412;">작업물이 마음에 드시길 바랍니다. 도움이 필요하실 땐 부담 없이 고객지원팀에 말씀해 주세요. 끝까지 편안하게 진행하실 수 있도록 함께하겠습니다.</p>

      <div style="height:1px; background:#e8f2ee; margin:18px 0;"></div>
      <p style="margin:0 0 6px; color:#0e1412;">정말 감사드립니다.<br>Audionyx 팀 드림</p>
    </div>
  </div>
</div>
      `.trim();
    }

    // 최종 확인 템플릿 UI 토글
    tplBtnFinalConfirmation.addEventListener("click", () => {
      finalPanel.classList.remove("hidden");
      // 스크롤 포커스
      finalPanel.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    fcCancelBtn.addEventListener("click", () => {
      finalPanel.classList.add("hidden");
    });

    // 파일을 base64로 읽는 유틸
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          // data:*/*;base64,xxxx 형태 → 콤마 뒤만 취함
          const base64 = typeof result === "string" ? result.split(",")[1] : "";
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // 현재 메시지에 첨부할 파일 보관소
    let currentAttachments = null;

    fcInsertBtn.addEventListener("click", async () => {
      const trackTitle = fcTrackTitle.value.trim();
      const artistName = fcArtistName.value.trim();
      const coverFile = fcCoverFile.files && fcCoverFile.files[0];
      const trackFile = fcTrackFile.files && fcTrackFile.files[0];

      if (!trackTitle || !artistName || !coverFile || !trackFile) {
        showResult("❌ 트랙 제목, 아티스트 명, 커버 이미지 파일, 트랙 파일을 모두 선택해주세요.", "error");
        return;
      }

      try {
        const [coverBase64, trackBase64] = await Promise.all([
          readFileAsBase64(coverFile),
          readFileAsBase64(trackFile)
        ]);

        currentAttachments = [
          {
            filename: coverFile.name,
            content: coverBase64,
            contentType: coverFile.type || undefined
          },
          {
            filename: trackFile.name,
            content: trackBase64,
            contentType: trackFile.type || undefined
          }
        ];

        const html = generateFinalConfirmationHtml({ 
          trackTitle, 
          artistName, 
          coverFileName: coverFile.name, 
          trackFileName: trackFile.name 
        });
        htmlTextarea.value = html;

        // 제목 자동 생성
        const subjectInput = document.getElementById("subject");
        subjectInput.value = `[Audionyx] 개인 음원 최종 확인 및 결제 안내 — ${trackTitle} (${artistName})`;

        showResult("✅ 최종 확인 템플릿이 본문에 삽입되었고, 파일 첨부가 준비되었습니다.", "success");
        finalPanel.classList.add("hidden");
      } catch (fileErr) {
        console.error("파일 읽기 오류", fileErr);
        showResult("❌ 파일을 읽는 중 오류가 발생했습니다.", "error");
      }
    });

    // 단일 버튼 바인딩 (향후 루프로 일반화 가능)
    tplBtnJpColdmail.addEventListener("click", () => {
      loadTemplateIntoEditor(
        "/japan-creator-coldmail.html",
        "【ご提案】AUDIONYXオリジナル音源で、クリエイター様の追加収益をサポート"
      );
    });
    tplBtnKrColdmail.addEventListener("click", () => {
      loadTemplateIntoEditor(
        "/korea-creator-coldmail.html",
        "[음원 협업 제안] Audionyx와 함께 개인 음원을 제작하고, 수익도 받아보세요!"
      );
    });
    // 이모지 키 템플릿 제거됨: 바인딩 삭제
    tplBtnTrackSubmitted.addEventListener("click", () => {
      loadTemplateIntoEditor(
        "/track-request-submitted.html",
        "[customer] 고객님께, AUDIONYX 개인음원 신청 완료"
      );
    });

    // 인증 상태 변경 감지
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loggedOut.classList.add("hidden");
        loggedIn.classList.remove("hidden");
        mailFormContainer.classList.remove("hidden");
        userInfo.textContent = `👤 ${user.displayName || user.email}`;
      } else {
        loggedOut.classList.remove("hidden");
        loggedIn.classList.add("hidden");
        mailFormContainer.classList.add("hidden");
      }
    });

    // 로그인 (팝업 차단/도메인 이슈 폴백)
    loginBtn.addEventListener("click", async () => {
      try {
        if (location.protocol === 'file:') {
          showResult("❌ 로컬 파일로 열렸습니다. http(s) 또는 localhost에서 접속해 주세요.", "error");
          return;
        }
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error("로그인 오류:", error);
        const code = error?.code || '';
        if (code === 'auth/popup-blocked' || code === 'auth/popup-closed-by-user') {
          try {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            const { signInWithRedirect } = await import('https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js');
            await signInWithRedirect(auth, provider);
            return;
          } catch (redirErr) {
            console.error('리다이렉트 로그인 오류:', redirErr);
          }
        }
        if (code === 'auth/unauthorized-domain') {
          showResult("❌ 인증 도메인이 허용되지 않았습니다. Firebase Auth 설정에서 현재 도메인을 허용 목록에 추가하세요.", "error");
          return;
        }
        showResult(`❌ 로그인 실패: ${code} ${error?.message || ''}`.trim(), "error");
      }
    });

    // 로그아웃
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error("로그아웃 오류:", error);
      }
    });

    // 미리보기
    previewBtn.addEventListener("click", () => {
      const raw = document.getElementById("html").value;
      const html = toHtmlPreserveLineBreaks(raw);
      previewContent.innerHTML = html;
      previewModal.classList.remove("hidden");
    });

    closePreview.addEventListener("click", () => {
      previewModal.classList.add("hidden");
    });

    // 메일 발송
    mailForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const emails = getAllEmails();
      const subject = document.getElementById("subject").value.trim();
      const rawHtmlInput = document.getElementById("html").value;
      const html = toHtmlPreserveLineBreaks(rawHtmlInput);

      // 유효성 검증
      if (emails.length === 0) {
        showResult("❌ 유효한 이메일 주소를 하나 이상 입력해주세요.", "error");
        return;
      }

      if (!subject || !html) {
        showResult("❌ 제목과 메일 내용을 입력해주세요.", "error");
        return;
      }

      // 인증 상태 확인
      const currentUser = auth.currentUser;
      if (!currentUser) {
        showResult("❌ 로그인이 필요합니다.", "error");
        return;
      }

      console.log("발송 대상 이메일:", emails);
      console.log("이메일 개수:", emails.length);

      sendBtn.disabled = true;
      sendBtn.textContent = `📨 ${emails.length}개 이메일로 개별 발송 중...`;

      try {
        // onRequest 함수 URL - us-central1 리전 및 프로젝트 ID에 맞게 설정
        const functionUrl = "https://us-central1-audionyx-a7b2e.cloudfunctions.net/sendMail";
        
        let sentCount = 0;
        const sentEmails = [];
        const failedEmails = [];

        for (let i = 0; i < emails.length; i++) {
          const email = emails[i];
          
          try {
            sendBtn.textContent = `📨 발송 중... (${i + 1}/${emails.length})`;
            
            const idToken = await currentUser.getIdToken();

            const mailData = { 
              to: email,
              subject, 
              html,
              ...(typeof currentAttachments !== "object" || currentAttachments === null ? {} : { attachments: currentAttachments })
            };

            const response = await fetch(functionUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${idToken}`
              },
              body: JSON.stringify(mailData)
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
              throw new Error(result.error || `HTTP error! status: ${response.status}`);
            }
            
            console.log(`이메일 발송 성공: ${email}`, result);
            sentCount++;
            sentEmails.push(email);

            if (i < emails.length - 1) {
              await new Promise(resolve => setTimeout(resolve, 500));
            }
            
          } catch (emailError) {
            console.error(`이메일 발송 실패: ${email}`, emailError);
            failedEmails.push({ email, error: emailError.message });
          }
        }
        
        // 발송 결과 처리
        if (sentCount === emails.length) {
          showResult(
            `✅ 개별 메일 발송이 성공적으로 완료되었습니다!\n` +
            `📧 발송 완료: ${sentCount}개 이메일 (각각 1대1 개별 발송)\n` +
            `📋 수신자: ${sentEmails.slice(0, 3).join(", ")}${sentEmails.length > 3 ? ` 외 ${sentEmails.length - 3}명` : ""}`, 
            "success"
          );
        } else if (sentCount > 0) {
          showResult(
            `⚠️ 일부 메일 발송이 완료되었습니다.\n` +
            `✅ 성공: ${sentCount}개 이메일\n` +
            `❌ 실패: ${failedEmails.length}개 이메일\n` +
            `📋 성공 수신자: ${sentEmails.slice(0, 2).join(", ")}${sentEmails.length > 2 ? ` 외 ${sentEmails.length - 2}명` : ""}\n` +
            `💥 실패 수신자: ${failedEmails.slice(0, 2).map(f => f.email).join(", ")}${failedEmails.length > 2 ? ` 외 ${failedEmails.length - 2}명` : ""}`, 
            "warning"
          );
        } else {
          showResult(
            `❌ 모든 메일 발송이 실패했습니다.\n` +
            `💥 실패 수신자: ${failedEmails.slice(0, 3).map(f => f.email).join(", ")}${failedEmails.length > 3 ? ` 외 ${failedEmails.length - 3}명` : ""}\n` +
            `💬 주요 오류: ${failedEmails[0]?.error || "알 수 없는 오류"}`, 
            "error"
          );
        }
        
        // 폼 초기화
        mailForm.reset();
        currentAttachments = null;
        
        if (!individualMode.classList.contains("hidden")) {
          emailList.innerHTML = `
            <div class="flex gap-3 email-item">
              <input type="email" class="audionyx-input flex-1 p-4 rounded-xl font-medium email-input" placeholder="recipient@example.com"/>
              <button type="button" class="audionyx-btn-secondary px-4 py-4 rounded-xl transition-all remove-email hover:bg-red-500 hover:border-red-500" title="이메일 제거">
                <span class="text-lg">🗑️</span>
              </button>
            </div>
          `;
          document.querySelector(".email-input").addEventListener("input", updateEmailCount);
          document.querySelector(".remove-email").addEventListener("click", (e) => {
            if (emailList.children.length > 1) {
              e.target.closest(".email-item").remove();
              updateEmailCount();
            }
          });
        }
        
        updateEmailCount();
        
      } catch (error) {
        console.error("메일 발송 프로세스 오류:", error);
        showResult(
          `❌ 메일 발송 중 심각한 오류가 발생했습니다.\n` +
          `💬 오류 메시지: ${error.message}`, 
          "error"
        );
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "📨 개별 메일 발송 (1대1)";
      }
    });

    // 결과 표시
    function showResult(message, type) {
      let bgClass, icon;
      
      switch(type) {
        case "success":
          bgClass = "audionyx-success";
          icon = "✅";
          break;
        case "warning":
          bgClass = "audionyx-warning";
          icon = "⚠️";
          break;
        case "error":
        default:
          bgClass = "audionyx-error";
          icon = "❌";
          break;
      }
      
      result.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="text-2xl">${icon}</span>
          <div class="flex-1">
            <pre class="whitespace-pre-wrap font-sans leading-relaxed">${message}</pre>
          </div>
        </div>
      `;
      
      result.className = `mt-8 p-6 rounded-2xl ${bgClass}`;
      result.classList.remove("hidden");
      
      // warning이나 error인 경우 더 오래 표시
      const displayTime = type === "error" || type === "warning" ? 8000 : 5000;
      
      setTimeout(() => {
        result.classList.add("hidden");
      }, displayTime);
    }

    // 모달 외부 클릭시 닫기
    previewModal.addEventListener("click", (e) => {
      if (e.target === previewModal) {
        previewModal.classList.add("hidden");
      }
    });
  </script>
</body>
</html> 