<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ë©”ì¼ ë°œì†¡ - Audionyx</title>
  <link href="https://unpkg.com/tailwindcss@2/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #3EB489;
      --color-primary-hover: #2A9D74;
      --color-accent: #A8E6CE;
      --color-neutral-dark: #0C0C0C;
      --color-surface: #FFFFFF;
      --color-border: #2A9D74;
      --color-text-light: #F0FFF0;
      --color-text-gray: #A7D3C9;
      --dark-bg: #000000;
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
      --radius-lg: 16px;
      --radius-md: 8px;
      --font-primary: 'Inter', 'Pretendard', sans-serif;
    }
    
    body {
      font-family: var(--font-primary);
      background: linear-gradient(135deg, #000000 0%, #0A0A0A 100%);
      color: var(--color-text-light);
    }
    
    .audionyx-card {
      background: linear-gradient(145deg, rgba(12, 12, 12, 0.9) 0%, rgba(20, 20, 20, 0.8) 100%);
      border: 1px solid rgba(62, 180, 137, 0.2);
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(10px);
    }
    
    .audionyx-btn-primary {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
      color: var(--color-neutral-dark);
      font-weight: 600;
      border: 1px solid rgba(168, 230, 206, 0.3);
      box-shadow: 0 4px 20px rgba(62, 180, 137, 0.4);
      transition: all 0.3s ease;
    }
    
    .audionyx-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(62, 180, 137, 0.6);
    }
    
    .audionyx-btn-secondary {
      background: rgba(62, 180, 137, 0.1);
      color: var(--color-text-light);
      border: 1px solid rgba(62, 180, 137, 0.3);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .audionyx-btn-secondary:hover {
      background: rgba(62, 180, 137, 0.2);
      border-color: var(--color-primary);
    }
    
    .audionyx-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(62, 180, 137, 0.2);
      color: var(--color-text-light);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .audionyx-input:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(62, 180, 137, 0.2);
      background: rgba(255, 255, 255, 0.08);
    }
    
    .audionyx-input::placeholder {
      color: var(--color-text-gray);
    }
    
    .audionyx-tab-active {
      background: var(--color-primary);
      color: var(--color-neutral-dark);
      box-shadow: 0 4px 12px rgba(62, 180, 137, 0.3);
    }
    
    .audionyx-tab-inactive {
      background: rgba(62, 180, 137, 0.1);
      color: var(--color-text-gray);
      border: 1px solid rgba(62, 180, 137, 0.2);
    }
    
    .audionyx-tab-inactive:hover {
      background: rgba(62, 180, 137, 0.15);
      color: var(--color-text-light);
    }
    
    .audionyx-success {
      background: linear-gradient(135deg, rgba(62, 180, 137, 0.2) 0%, rgba(42, 157, 116, 0.1) 100%);
      border: 1px solid rgba(62, 180, 137, 0.4);
      color: var(--color-accent);
    }
    
    .audionyx-warning {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 193, 7, 0.1) 100%);
      border: 1px solid rgba(255, 193, 7, 0.4);
      color: #FFE082;
    }
    
    .audionyx-error {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.2) 0%, rgba(244, 67, 54, 0.1) 100%);
      border: 1px solid rgba(244, 67, 54, 0.4);
      color: #FFCDD2;
    }
    
    .audionyx-gradient-border {
      position: relative;
      background: linear-gradient(145deg, rgba(12, 12, 12, 0.9) 0%, rgba(20, 20, 20, 0.8) 100%);
    }
    
    .audionyx-gradient-border::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: subtract;
      -webkit-mask-composite: xor;
    }
    
    .glass-effect {
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-6 py-12">
    <div class="max-w-5xl mx-auto">
      <!-- í—¤ë” ì„¹ì…˜ -->
      <div class="text-center mb-12">
        <div class="inline-flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center">
            <span class="text-2xl">ğŸ“§</span>
          </div>
          <h1 class="text-4xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
            AUDIONYX
          </h1>
        </div>
        <p class="text-xl font-semibold mb-2" style="color: var(--color-text-light);">ê´€ë¦¬ì ë©”ì¼ ë°œì†¡ ì‹œìŠ¤í…œ</p>
        <p class="text-sm opacity-75" style="color: var(--color-text-gray);">ê°œë³„ 1ëŒ€1 ë©”ì¼ ë°œì†¡ìœ¼ë¡œ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤</p>
      </div>
      
      <!-- ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ -->
      <div id="auth-status" class="mb-8 audionyx-card rounded-2xl p-6">
        <div id="logged-out" class="text-center">
          <div class="mb-6">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full glass-effect flex items-center justify-center">
              <span class="text-3xl">ğŸ”</span>
            </div>
            <h3 class="text-lg font-semibold mb-2" style="color: var(--color-text-light);">ê´€ë¦¬ì ì¸ì¦ í•„ìš”</h3>
            <p class="text-sm mb-6" style="color: var(--color-text-gray);">ë©”ì¼ì„ ë°œì†¡í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
          </div>
          <button id="login-btn" class="audionyx-btn-primary px-8 py-3 rounded-xl font-semibold inline-flex items-center gap-2">
            <span class="text-lg">ğŸ”‘</span>
            Google ë¡œê·¸ì¸
          </button>
        </div>
        <div id="logged-in" class="hidden">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center">
                <span class="text-lg">ğŸ‘¤</span>
              </div>
              <div>
                <span id="user-info" class="font-semibold" style="color: var(--color-text-light);"></span>
                <p class="text-xs" style="color: var(--color-text-gray);">ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸ë¨</p>
              </div>
            </div>
            <button id="logout-btn" class="audionyx-btn-secondary px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </div>

      <!-- ë©”ì¼ ë°œì†¡ í¼ -->
      <div id="mail-form-container" class="hidden">
        <form id="mail-form" class="space-y-8 audionyx-card rounded-2xl p-8">
          <!-- ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼ ì„¹ì…˜ -->
          <div>
            <div class="flex items-center gap-2 mb-4">
              <span class="text-lg">ğŸ“®</span>
              <label class="block text-lg font-semibold" style="color: var(--color-text-light);">ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼</label>
            </div>
            
            <!-- ì…ë ¥ ë°©ì‹ ì„ íƒ íƒ­ -->
            <div class="flex mb-6 glass-effect rounded-xl p-1.5">
              <button 
                type="button" 
                id="tab-individual" 
                class="audionyx-tab-active flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all"
              >
                <span class="mr-2">ğŸ“</span>ê°œë³„ ì¶”ê°€
              </button>
              <button 
                type="button" 
                id="tab-bulk" 
                class="audionyx-tab-inactive flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all"
              >
                <span class="mr-2">ğŸ“‹</span>ì¼ê´„ ì…ë ¥
              </button>
            </div>

            <!-- ê°œë³„ ì¶”ê°€ ë°©ì‹ -->
            <div id="individual-mode">
              <div class="space-y-3 mb-4" id="email-list">
                <div class="flex gap-3 email-item">
                  <input 
                    type="email" 
                    class="audionyx-input flex-1 p-4 rounded-xl font-medium email-input" 
                    placeholder="recipient@example.com"
                  />
                  <button 
                    type="button" 
                    class="audionyx-btn-secondary px-4 py-4 rounded-xl transition-all remove-email hover:bg-red-500 hover:border-red-500"
                    title="ì´ë©”ì¼ ì œê±°"
                  >
                    <span class="text-lg">ğŸ—‘ï¸</span>
                  </button>
                </div>
              </div>
              <button 
                type="button" 
                id="add-email" 
                class="audionyx-btn-secondary w-full py-3 rounded-xl font-medium transition-all inline-flex items-center justify-center gap-2"
              >
                <span class="text-lg">â•</span>
                ì´ë©”ì¼ ì¶”ê°€
              </button>
              <div class="mt-4 p-4 glass-effect rounded-xl">
                <div class="flex items-start gap-2 text-sm" style="color: var(--color-text-gray);">
                  <span class="text-base">ğŸ’¡</span>
                  <span>ê° ì´ë©”ì¼ ì£¼ì†Œë¥¼ ê°œë³„ì ìœ¼ë¡œ ì¶”ê°€í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                </div>
              </div>
            </div>

            <!-- ì¼ê´„ ì…ë ¥ ë°©ì‹ -->
            <div id="bulk-mode" class="hidden">
              <textarea 
                id="bulk-emails" 
                rows="6"
                class="audionyx-input w-full p-4 rounded-xl font-medium" 
                placeholder="ì—¬ëŸ¬ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì‰¼í‘œ(,), ì„¸ë¯¸ì½œë¡ (;) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.&#10;&#10;ì˜ˆì‹œ:&#10;user1@example.com, user2@example.com&#10;user3@example.com"
              ></textarea>
              <div class="mt-4 p-4 glass-effect rounded-xl">
                <div class="flex items-start gap-2 text-sm" style="color: var(--color-text-gray);">
                  <span class="text-base">ğŸ’¡</span>
                  <span>ì‰¼í‘œ(,), ì„¸ë¯¸ì½œë¡ (;) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ì´ë©”ì¼ì„ êµ¬ë¶„í•´ì£¼ì„¸ìš”.</span>
                </div>
              </div>
            </div>

            <!-- ì´ë©”ì¼ ê°œìˆ˜ í‘œì‹œ -->
            <div class="mt-6 p-4 audionyx-gradient-border rounded-xl">
              <div class="relative z-10">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">ğŸ“§</span>
                  <span class="font-semibold" style="color: var(--color-text-light);">
                    ë°œì†¡ ëŒ€ìƒ: <span id="email-count-number" class="font-bold" style="color: var(--color-primary);">1</span>ê°œ ì´ë©”ì¼
                  </span>
                </div>
                <div class="flex items-center gap-2 text-sm" style="color: var(--color-text-gray);">
                  <span>ğŸ”’</span>
                  <span>ê°œì¸ì •ë³´ ë³´í˜¸: ê° ìˆ˜ì‹ ìëŠ” ë‹¤ë¥¸ ìˆ˜ì‹ ìì˜ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (1ëŒ€1 ê°œë³„ ë°œì†¡)</span>
                </div>
            </div>
            </div>
          </div>
          
          <!-- ì œëª© ì…ë ¥ -->
          <div>
            <div class="flex items-center gap-2 mb-4">
              <span class="text-lg">ğŸ“</span>
              <label for="subject" class="block text-lg font-semibold" style="color: var(--color-text-light);">ë©”ì¼ ì œëª©</label>
            </div>
            <input 
              id="subject" 
              type="text" 
              class="audionyx-input w-full p-4 rounded-xl font-medium" 
              placeholder="ë©”ì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>
          
          <!-- ë©”ì¼ ë‚´ìš© ì…ë ¥ -->
          <div>
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ’Œ</span>
                <label for="html" class="block text-lg font-semibold" style="color: var(--color-text-light);">ë©”ì¼ ë‚´ìš© (HTML)</label>
              </div>
              <!-- í…œí”Œë¦¿ ë²„íŠ¼ ì˜ì—­ -->
              <div class="flex gap-2">
                <button 
                  type="button" 
                  id="tpl-jp-coldmail"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="ì¼ë³¸ í¬ë¦¬ì—ì´í„° ì½œë“œ ë©”ì¼ í…œí”Œë¦¿ ì‚½ì…"
                >
                  <span>ğŸ‡¯ğŸ‡µ</span>
                  ì¼ë³¸ ì½œë“œë©”ì¼
                </button>
                <button 
                  type="button" 
                  id="tpl-kr-coldmail"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="í•œêµ­ í¬ë¦¬ì—ì´í„° ì½œë“œ ë©”ì¼ í…œí”Œë¦¿ ì‚½ì…"
                >
                  <span>ğŸ‡°ğŸ‡·</span>
                  í•œêµ­ ì½œë“œë©”ì¼
                </button>
                
                <button 
                  type="button" 
                  id="tpl-track-submitted"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="ê°œì¸ ìŒì› ì‹ ì²­ ì ‘ìˆ˜ì™„ë£Œ í…œí”Œë¦¿ ì‚½ì…"
                >
                  <span>âœ…</span>
                  ì ‘ìˆ˜ì™„ë£Œ ì•ˆë‚´
                </button>
                <button 
                  type="button" 
                  id="tpl-final-confirmation"
                  class="audionyx-btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2 transition-all"
                  title="ê°œì¸ ìŒì› ìµœì¢… í™•ì¸ ì•ˆë‚´ í…œí”Œë¦¿ ìƒì„±"
                >
                  <span>ğŸ§¾</span>
                  ìµœì¢… í™•ì¸ ì•ˆë‚´
                </button>
                <!-- í–¥í›„ í…œí”Œë¦¿ í™•ì¥ ìë¦¬: ìë™ ë£¨í”„ ìƒì„± ì˜ˆì • -->
              </div>
            </div>
            <!-- ê°œì¸ ìŒì› ìµœì¢… í™•ì¸ ì…ë ¥ íŒ¨ë„ (ë²„íŠ¼ í´ë¦­ ì‹œ í‘œì‹œ) -->
            <div id="final-confirmation-panel" class="hidden mt-4 p-6 glass-effect rounded-xl space-y-4">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-lg">ğŸ§¾</span>
                <h4 class="font-semibold" style="color: var(--color-text-light);">ê°œì¸ ìŒì› ìµœì¢… í™•ì¸ â€” ë‚´ìš© ìë™ ìƒì„±</h4>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="fc-track-title" class="block text-sm mb-2" style="color: var(--color-text-gray);">íŠ¸ë™ ì œëª©</label>
                  <input id="fc-track-title" type="text" class="audionyx-input w-full p-3 rounded-xl font-medium" placeholder="ì˜ˆ: Sunset Drive" />
                </div>
                <div>
                  <label for="fc-artist-name" class="block text-sm mb-2" style="color: var(--color-text-gray);">ì•„í‹°ìŠ¤íŠ¸ ëª…</label>
                  <input id="fc-artist-name" type="text" class="audionyx-input w-full p-3 rounded-xl font-medium" placeholder="ì˜ˆ: Audionyx" />
                </div>
                <div>
                  <label for="fc-cover-file" class="block text-sm mb-2" style="color: var(--color-text-gray);">ì»¤ë²„ ì´ë¯¸ì§€ (íŒŒì¼ ì²¨ë¶€)</label>
                  <input id="fc-cover-file" type="file" accept="image/*" class="audionyx-input w-full p-3 rounded-xl font-medium" />
                </div>
                <div>
                  <label for="fc-track-file" class="block text-sm mb-2" style="color: var(--color-text-gray);">íŠ¸ë™ íŒŒì¼ (íŒŒì¼ ì²¨ë¶€)</label>
                  <input id="fc-track-file" type="file" accept="audio/*" class="audionyx-input w-full p-3 rounded-xl font-medium" />
                </div>
              </div>
              <div class="flex items-center gap-3 pt-2">
                <button type="button" id="final-confirmation-insert" class="audionyx-btn-primary px-5 py-3 rounded-xl text-sm font-semibold inline-flex items-center gap-2">
                  <span>ğŸ§©</span>
                  ë³¸ë¬¸ì— ì‚½ì…
                </button>
                <button type="button" id="final-confirmation-cancel" class="audionyx-btn-secondary px-5 py-3 rounded-xl text-sm font-medium inline-flex items-center gap-2">
                  ì·¨ì†Œ/ë‹«ê¸°
                </button>
                <div class="text-xs" style="color: var(--color-text-gray);">
                  ê³„ì¢Œ: <span class="font-semibold" style="color: var(--color-text-light);">í•˜ë‚˜ì€í–‰ 823-910017-83704</span> (ì˜ˆê¸ˆì£¼: ì£¼ì‹íšŒì‚¬ ì˜¤ë””ì˜¤ë‹‰ìŠ¤)
                </div>
              </div>
            </div>
            <textarea 
              id="html" 
              rows="14"
              class="audionyx-input w-full p-4 rounded-xl font-mono text-sm leading-relaxed" 
              placeholder="<h1>ì•ˆë…•í•˜ì„¸ìš”!</h1><p>ë©”ì¼ ë³¸ë¬¸ì„ HTMLë¡œ ì‘ì„±í•˜ì„¸ìš”.</p>"
              required
            ></textarea>
          </div>
          
          <!-- ë°œì†¡ ë²„íŠ¼ -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
            <button 
              type="submit" 
              class="audionyx-btn-primary p-4 rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-3"
              id="send-btn"
            >
              <span class="text-xl">ğŸ“¨</span>
              <span>ê°œë³„ ë©”ì¼ ë°œì†¡ (1ëŒ€1)</span>
            </button>
            <button 
              type="button" 
              id="preview-btn"
              class="audionyx-btn-secondary p-4 rounded-xl font-semibold transition-all inline-flex items-center justify-center gap-3"
            >
              <span class="text-xl">ğŸ‘ï¸</span>
              <span>ë¯¸ë¦¬ë³´ê¸°</span>
            </button>
          </div>
        </form>
      </div>

      <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
      <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="audionyx-card max-w-5xl overflow-hidden rounded-2xl m-6 flex flex-col" style="max-height: 90vh;">
          <div class="flex justify-between items-center p-6 border-b border-gray-700 flex-shrink-0">
            <div class="flex items-center gap-2">
              <span class="text-lg">ğŸ‘ï¸</span>
              <h3 class="text-xl font-semibold" style="color: var(--color-text-light);">ë©”ì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
            </div>
            <button id="close-preview" class="audionyx-btn-secondary w-10 h-10 rounded-full flex items-center justify-center text-lg transition-all">
              âœ•
            </button>
          </div>
          <div class="p-6 overflow-y-auto flex-1 min-h-0" style="overflow-y: auto; min-height: 0;">
            <div id="preview-content" class="bg-white rounded-xl p-6 text-black min-h-full"></div>
          </div>
        </div>
      </div>

      <!-- ë°œì†¡ ê²°ê³¼ -->
      <div id="result" class="mt-8 p-6 rounded-2xl hidden"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-functions.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBP926ULg9wNUNGjQy0fMjRxUeS4XyeG6M",
      authDomain: "audionyx-a7b2e.firebaseapp.com",
      projectId: "audionyx-a7b2e",
      storageBucket: "audionyx-a7b2e.firebasestorage.app",
      messagingSenderId: "1002069862376",
      appId: "1:1002069862376:web:669c93bca8ab2f1d09665d",
      measurementId: "G-P6GNNYLJ38"
    };

    const app = initializeApp(firebaseConfig);
    const functions = getFunctions(app);
    const auth = getAuth(app);

    // DOM ìš”ì†Œë“¤
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const loggedOut = document.getElementById("logged-out");
    const loggedIn = document.getElementById("logged-in");
    const userInfo = document.getElementById("user-info");
    const mailFormContainer = document.getElementById("mail-form-container");
    const mailForm = document.getElementById("mail-form");
    const sendBtn = document.getElementById("send-btn");
    const previewBtn = document.getElementById("preview-btn");
    const previewModal = document.getElementById("preview-modal");
    const previewContent = document.getElementById("preview-content");
    const closePreview = document.getElementById("close-preview");
    const result = document.getElementById("result");
    const htmlTextarea = document.getElementById("html");
    const tplBtnJpColdmail = document.getElementById("tpl-jp-coldmail");
    const tplBtnKrColdmail = document.getElementById("tpl-kr-coldmail");
    const tplBtnTrackSubmitted = document.getElementById("tpl-track-submitted");
    const tplBtnFinalConfirmation = document.getElementById("tpl-final-confirmation");

    // í…œí”Œë¦¿ ì •ì˜ (í–¥í›„ í™•ì¥ ê°€ëŠ¥ êµ¬ì¡°)
    const mailTemplates = [
      { id: "jp-coldmail", label: "ğŸ‡¯ğŸ‡µ ì¼ë³¸ ì½œë“œë©”ì¼ í…œí”Œë¦¿", path: "/japan-creator-coldmail.html" },
      { id: "kr-coldmail", label: "ğŸ‡°ğŸ‡· í•œêµ­ ì½œë“œë©”ì¼ í…œí”Œë¦¿", path: "/korea-creator-coldmail.html" },
      { id: "track-submitted", label: "âœ… ê°œì¸ ìŒì› ì‹ ì²­ ì ‘ìˆ˜ì™„ë£Œ", path: "/track-request-submitted.html" }
    ];

    // ì¼ë°˜ í…ìŠ¤íŠ¸ â†’ HTML ë³€í™˜ ìœ í‹¸ (ì¤„ë°”ê¿ˆ ë³´ì¡´)
    function isLikelyHtml(input) {
      if (typeof input !== "string") return false;
      return /<\/?[a-z][\s\S]*>/i.test(input);
    }

    function escapeHtml(unsafe) {
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function toHtmlPreserveLineBreaks(input) {
      const value = String(input ?? "");
      if (isLikelyHtml(value)) return value;
      const escaped = escapeHtml(value);
      // ë‹¨ìˆœ ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
      return escaped.replace(/\r\n|\r|\n/g, '<br>');
    }

    // ìƒˆë¡œìš´ ì´ë©”ì¼ ê´€ë ¨ DOM ìš”ì†Œë“¤
    const tabIndividual = document.getElementById("tab-individual");
    const tabBulk = document.getElementById("tab-bulk");
    const individualMode = document.getElementById("individual-mode");
    const bulkMode = document.getElementById("bulk-mode");
    const emailList = document.getElementById("email-list");
    const addEmailBtn = document.getElementById("add-email");
    const bulkEmails = document.getElementById("bulk-emails");
    const emailCountNumber = document.getElementById("email-count-number");
    // ìµœì¢… í™•ì¸ í…œí”Œë¦¿ ì „ìš© ìš”ì†Œ
    const finalPanel = document.getElementById("final-confirmation-panel");
    const fcTrackTitle = document.getElementById("fc-track-title");
    const fcArtistName = document.getElementById("fc-artist-name");
    const fcCoverFile = document.getElementById("fc-cover-file");
    const fcTrackFile = document.getElementById("fc-track-file");
    const fcInsertBtn = document.getElementById("final-confirmation-insert");
    const fcCancelBtn = document.getElementById("final-confirmation-cancel");

    // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì¦ í•¨ìˆ˜
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email.trim());
    }

    // ì´ë©”ì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateEmailCount() {
      const emails = getAllEmails();
      emailCountNumber.textContent = emails.length;
      // ì¤‘ë³µ ì œê±°ë¡œ ì¸í•´ ì‹¤ì œ ì „ì†¡ ëŒ€ìƒ ìˆ˜ í‘œì‹œê°€ ë³€ê²½ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ì—…ë°ì´íŠ¸í•˜ë ¤ë©´ ì´ ì§€ì ì—ì„œ í›„ì† UI ì—…ë°ì´íŠ¸ ê°€ëŠ¥
    }

    // ëª¨ë“  ì´ë©”ì¼ ì£¼ì†Œ ìˆ˜ì§‘ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±° í¬í•¨)
    function getAllEmails() {
      const seen = new Set();
      const result = [];

      if (individualMode.classList.contains("hidden")) {
        // ì¼ê´„ ì…ë ¥ ëª¨ë“œ
        const bulkText = bulkEmails.value.trim();
        if (!bulkText) return [];

        const parsed = bulkText
          .split(/[,;\n]/)
          .map(email => email.trim())
          .filter(email => email && isValidEmail(email));

        for (const email of parsed) {
          const key = email.toLowerCase();
          if (!seen.has(key)) {
            seen.add(key);
            result.push(email);
          }
        }
      } else {
        // ê°œë³„ ì¶”ê°€ ëª¨ë“œ
        const emailInputs = emailList.querySelectorAll(".email-input");
        emailInputs.forEach(input => {
          const email = input.value.trim();
          if (email && isValidEmail(email)) {
            const key = email.toLowerCase();
            if (!seen.has(key)) {
              seen.add(key);
              result.push(email);
            }
          }
        });
      }

      return result;
    }

    // ì´ë©”ì¼ ì•„ì´í…œ ìƒì„± í•¨ìˆ˜
    function createEmailItem() {
      const emailItem = document.createElement("div");
      emailItem.className = "flex gap-3 email-item";
      emailItem.innerHTML = `
        <input 
          type="email" 
          class="audionyx-input flex-1 p-4 rounded-xl font-medium email-input" 
          placeholder="recipient@example.com"
        />
        <button 
          type="button" 
          class="audionyx-btn-secondary px-4 py-4 rounded-xl transition-all remove-email hover:bg-red-500 hover:border-red-500"
          title="ì´ë©”ì¼ ì œê±°"
        >
          <span class="text-lg">ğŸ—‘ï¸</span>
        </button>
      `;

      // ì´ë©”ì¼ ì…ë ¥ ì‹œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      const emailInput = emailItem.querySelector(".email-input");
      emailInput.addEventListener("input", updateEmailCount);

      // ì œê±° ë²„íŠ¼ ì´ë²¤íŠ¸
      const removeBtn = emailItem.querySelector(".remove-email");
      removeBtn.addEventListener("click", () => {
        if (emailList.children.length > 1) {
          emailItem.remove();
          updateEmailCount();
        }
      });

      return emailItem;
    }

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function switchTab(mode) {
      if (mode === "individual") {
        tabIndividual.className = "audionyx-tab-active flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        tabBulk.className = "audionyx-tab-inactive flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        
        individualMode.classList.remove("hidden");
        bulkMode.classList.add("hidden");
      } else {
        tabBulk.className = "audionyx-tab-active flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        tabIndividual.className = "audionyx-tab-inactive flex-1 py-3 px-6 rounded-lg text-sm font-semibold transition-all";
        
        bulkMode.classList.remove("hidden");
        individualMode.classList.add("hidden");
      }
      updateEmailCount();
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    tabIndividual.addEventListener("click", () => switchTab("individual"));
    tabBulk.addEventListener("click", () => switchTab("bulk"));

    // ì´ë©”ì¼ ì¶”ê°€ ë²„íŠ¼
    addEmailBtn.addEventListener("click", () => {
      const newEmailItem = createEmailItem();
      emailList.appendChild(newEmailItem);
      newEmailItem.querySelector(".email-input").focus();
      updateEmailCount();
    });

    // ì¼ê´„ ì…ë ¥ í…ìŠ¤íŠ¸ ë³€ê²½ ì‹œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    bulkEmails.addEventListener("input", updateEmailCount);

    // ì´ˆê¸° ì´ë©”ì¼ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelector(".email-input").addEventListener("input", updateEmailCount);
    document.querySelector(".remove-email").addEventListener("click", (e) => {
      if (emailList.children.length > 1) {
        e.target.closest(".email-item").remove();
        updateEmailCount();
      }
    });

    // í…œí”Œë¦¿ ë¡œë”: íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ textareaì— ì‚½ì…
    async function loadTemplateIntoEditor(templatePath, subjectToSet) {
      try {
        const res = await fetch(templatePath, { cache: "no-cache" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const htmlText = await res.text();
        htmlTextarea.value = htmlText;
        if (typeof subjectToSet === "string" && subjectToSet.trim().length > 0) {
          const subjectInput = document.getElementById("subject");
          subjectInput.value = subjectToSet;
        }
        showResult("âœ… í…œí”Œë¦¿ì´ ë³¸ë¬¸ì— ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
      } catch (err) {
        console.error("í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨:", err);
        showResult("âŒ í…œí”Œë¦¿ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
      }
    }

    // ê°œì¸ ìŒì› ìµœì¢… í™•ì¸ â€” HTML ìƒì„±ê¸°
    function generateFinalConfirmationHtml({ trackTitle, artistName, coverFileName, trackFileName }) {
      const accountNumber = "í•˜ë‚˜ì€í–‰ 823-910017-83704";
      const accountHolder = "ì£¼ì‹íšŒì‚¬ ì˜¤ë””ì˜¤ë‹‰ìŠ¤";
      const depositAmount = 49000; // ì”ê¸ˆ
      const fmt = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return `
<div style="font-family: 'Inter', 'Apple SD Gothic Neo', 'Malgun Gothic', Arial, sans-serif; background:#f6fbf9; padding:24px;">
  <div style="max-width:720px; margin:0 auto; background:#ffffff; border:1px solid #d9efe7; border-radius:12px; overflow:hidden;">
    <div style="background:linear-gradient(135deg,#3EB489,#2A9D74); color:#0b1f17; padding:18px 22px;">
      <div style="font-weight:700; font-size:18px; color:#052d23;">Audionyx â€¢ ê°œì¸ ìŒì› ìµœì¢… í™•ì¸</div>
      <div style="font-size:12px; color:#083b2d; opacity:0.9; margin-top:2px;">Thank you for creating with us</div>
    </div>

    <div style="padding:24px 22px 8px; color:#0e1412; line-height:1.7;">
      <p style="margin:0 0 14px;">ì•ˆë…•í•˜ì„¸ìš”, Audionyxë¥¼ ë¯¿ê³  ë§¡ê²¨ ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.<br>ì ‘ìˆ˜ ì™„ë£Œ ë©”ì¼ì—ì„œ ì•ˆë‚´ë“œë¦° íë¦„ì— ë”°ë¼ ì•„ë˜ ë‚´ìš©ì„ ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í•´ ì£¼ì„¸ìš”. <strong>ì”ê¸ˆ ì…ê¸ˆì´ í™•ì¸ë˜ëŠ” ì¦‰ì‹œ</strong> ìœ í†µ ì¤€ë¹„ë¥¼ ë°”ë¡œ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

      <div style="font-weight:700; font-size:16px; margin:18px 0 8px; color:#0e1412;">[1] ìµœì¢… í™•ì¸ í•­ëª©</div>
      <ul style="padding-left:18px; margin:0 0 12px;">
        <li><strong>íŠ¸ë™ ì œëª©:</strong> ${trackTitle}</li>
        <li><strong>ì•„í‹°ìŠ¤íŠ¸ í‘œê¸°:</strong> ${artistName}</li>
        <li><strong>ì»¤ë²„ ì´ë¯¸ì§€:</strong> ì²¨ë¶€ (${coverFileName})</li>
        <li><strong>íŠ¸ë™ íŒŒì¼(ìµœì¢…ë³¸):</strong> ì²¨ë¶€ (${trackFileName})</li>
      </ul>

      <div style="border:1px solid #c8eadf; background:#eff9f5; border-radius:10px; padding:14px 16px; margin:14px 0;">
        <div style="font-weight:700; color:#0d2f25; margin-bottom:6px;">[2] ì”ê¸ˆ ë° í™•ì • ì•ˆë‚´</div>
        <div style="margin:4px 0;"><strong>ì…ê¸ˆ ê¸ˆì•¡(ì”ê¸ˆ):</strong> ${fmt(depositAmount)}ì›</div>
        <div style="margin:4px 0;"><strong>ì…ê¸ˆ ê³„ì¢Œ:</strong> ${accountNumber} <span style="color:#2a7a62;">(ì˜ˆê¸ˆì£¼: ${accountHolder})</span></div>
        <div style="margin:4px 0;">íšŒì‹  ì ˆì°¨ëŠ” í•„ìš” ì—†ìŠµë‹ˆë‹¤. <strong>ì”ê¸ˆ ì…ê¸ˆì´ í™•ì¸ë˜ëŠ” ì¦‰ì‹œ</strong> ìœ í†µì„ ì‹œì‘í•˜ë©°, ê³µì‹ ì‚¬ì´íŠ¸ <strong>ìŒì› ì‹ ì²­</strong> í˜ì´ì§€ í•˜ë‹¨ <strong>ë‚´ ìš”ì²­ ëª©ë¡</strong>ì˜ ìƒíƒœ ë±ƒì§€ê°€ <strong>â€˜ìœ í†µ ëŒ€ê¸°â€™ â†’ â€˜ìœ í†µì¤‘â€™</strong>ìœ¼ë¡œ ìë™ ë³€ê²½ë©ë‹ˆë‹¤.</div>
        <div style="margin:6px 0 0; color:#0d2f25;">ìœ í†µ ì‹œì‘ í›„ ë§ˆë¬´ë¦¬ê¹Œì§€ëŠ” í‰ê·  2ì£¼ ì†Œìš”ë©ë‹ˆë‹¤ (í”Œë«í¼ ì‹¬ì‚¬ í¬í•¨).</div>
      </div>

      <div style="border:1px solid #d9efe7; background:#f7fbfa; border-radius:10px; padding:14px 16px; margin:14px 0;">
        <div style="font-weight:700; color:#0d2f25; margin-bottom:6px;">[3] ê³ ê°ì§€ì› ì•ˆë‚´</div>
        <div style="margin:4px 0;">ì§„í–‰ ì¤‘ ê¶ê¸ˆí•˜ì‹  ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ <strong>ì˜¤ë””ì˜¤ë‹‰ìŠ¤ ê³ ê°ì§€ì›íŒ€</strong>ìœ¼ë¡œ ì—°ë½ ì£¼ì„¸ìš”. ì¹œì ˆí•˜ê³  ì‹ ì†í•˜ê²Œ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</div>
        <div style="margin:4px 0;">ì…ê¸ˆ í™•ì¸ì´ í•„ìš”í•˜ì‹œë‹¤ë©´ <strong>ì±„ë„í†¡</strong>ìœ¼ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”. ì‚¬ì´íŠ¸ ì ‘ì† í›„ ìš°ì¸¡ í•˜ë‹¨ ë§í’ì„  ì•„ì´ì½˜ì„ í†µí•´ ë°”ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.</div>
        <div style="margin:4px 0;"><a href="https://audio-nyx.com?chat=open" style="color:#2A9D74; text-decoration:none;">ì±„ë„í†¡ìœ¼ë¡œ ë¬¸ì˜í•˜ê¸°</a></div>
        <div style="margin:4px 0;"><strong>ì´ë©”ì¼:</strong> <a href="mailto:audionyx369@gmail.com" style="color:#2A9D74; text-decoration:none;">audionyx369@gmail.com</a></div>
        <div style="margin:4px 0; color:#0d2f25;">ìš´ì˜ ì‹œê°„: í‰ì¼ 10:00â€“18:00 (ì ì‹¬ 12:30â€“13:30)</div>
      </div>

      <p style="margin:14px 0; color:#0e1412;">ì‘ì—…ë¬¼ì´ ë§ˆìŒì— ë“œì‹œê¸¸ ë°”ëë‹ˆë‹¤. ë„ì›€ì´ í•„ìš”í•˜ì‹¤ ë• ë¶€ë‹´ ì—†ì´ ê³ ê°ì§€ì›íŒ€ì— ë§ì”€í•´ ì£¼ì„¸ìš”. ëê¹Œì§€ í¸ì•ˆí•˜ê²Œ ì§„í–‰í•˜ì‹¤ ìˆ˜ ìˆë„ë¡ í•¨ê»˜í•˜ê² ìŠµë‹ˆë‹¤.</p>

      <div style="height:1px; background:#e8f2ee; margin:18px 0;"></div>
      <p style="margin:0 0 6px; color:#0e1412;">ì •ë§ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.<br>Audionyx íŒ€ ë“œë¦¼</p>
    </div>
  </div>
</div>
      `.trim();
    }

    // ìµœì¢… í™•ì¸ í…œí”Œë¦¿ UI í† ê¸€
    tplBtnFinalConfirmation.addEventListener("click", () => {
      finalPanel.classList.remove("hidden");
      // ìŠ¤í¬ë¡¤ í¬ì»¤ìŠ¤
      finalPanel.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    fcCancelBtn.addEventListener("click", () => {
      finalPanel.classList.add("hidden");
    });

    // íŒŒì¼ì„ base64ë¡œ ì½ëŠ” ìœ í‹¸
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          // data:*/*;base64,xxxx í˜•íƒœ â†’ ì½¤ë§ˆ ë’¤ë§Œ ì·¨í•¨
          const base64 = typeof result === "string" ? result.split(",")[1] : "";
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // í˜„ì¬ ë©”ì‹œì§€ì— ì²¨ë¶€í•  íŒŒì¼ ë³´ê´€ì†Œ
    let currentAttachments = null;

    fcInsertBtn.addEventListener("click", async () => {
      const trackTitle = fcTrackTitle.value.trim();
      const artistName = fcArtistName.value.trim();
      const coverFile = fcCoverFile.files && fcCoverFile.files[0];
      const trackFile = fcTrackFile.files && fcTrackFile.files[0];

      if (!trackTitle || !artistName || !coverFile || !trackFile) {
        showResult("âŒ íŠ¸ë™ ì œëª©, ì•„í‹°ìŠ¤íŠ¸ ëª…, ì»¤ë²„ ì´ë¯¸ì§€ íŒŒì¼, íŠ¸ë™ íŒŒì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      try {
        const [coverBase64, trackBase64] = await Promise.all([
          readFileAsBase64(coverFile),
          readFileAsBase64(trackFile)
        ]);

        currentAttachments = [
          {
            filename: coverFile.name,
            content: coverBase64,
            contentType: coverFile.type || undefined
          },
          {
            filename: trackFile.name,
            content: trackBase64,
            contentType: trackFile.type || undefined
          }
        ];

        const html = generateFinalConfirmationHtml({ 
          trackTitle, 
          artistName, 
          coverFileName: coverFile.name, 
          trackFileName: trackFile.name 
        });
        htmlTextarea.value = html;

        // ì œëª© ìë™ ìƒì„±
        const subjectInput = document.getElementById("subject");
        subjectInput.value = `[Audionyx] ê°œì¸ ìŒì› ìµœì¢… í™•ì¸ ë° ê²°ì œ ì•ˆë‚´ â€” ${trackTitle} (${artistName})`;

        showResult("âœ… ìµœì¢… í™•ì¸ í…œí”Œë¦¿ì´ ë³¸ë¬¸ì— ì‚½ì…ë˜ì—ˆê³ , íŒŒì¼ ì²¨ë¶€ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        finalPanel.classList.add("hidden");
      } catch (fileErr) {
        console.error("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜", fileErr);
        showResult("âŒ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
      }
    });

    // ë‹¨ì¼ ë²„íŠ¼ ë°”ì¸ë”© (í–¥í›„ ë£¨í”„ë¡œ ì¼ë°˜í™” ê°€ëŠ¥)
    tplBtnJpColdmail.addEventListener("click", () => {
      loadTemplateIntoEditor(
        "/japan-creator-coldmail.html",
        "ã€ã”ææ¡ˆã€‘AUDIONYXã‚ªãƒªã‚¸ãƒŠãƒ«éŸ³æºã§ã€ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼æ§˜ã®è¿½åŠ åç›Šã‚’ã‚µãƒãƒ¼ãƒˆ"
      );
    });
    tplBtnKrColdmail.addEventListener("click", () => {
      loadTemplateIntoEditor(
        "/korea-creator-coldmail.html",
        "[ìŒì› í˜‘ì—… ì œì•ˆ] Audionyxì™€ í•¨ê»˜ ê°œì¸ ìŒì›ì„ ì œì‘í•˜ê³ , ìˆ˜ìµë„ ë°›ì•„ë³´ì„¸ìš”!"
      );
    });
    // ì´ëª¨ì§€ í‚¤ í…œí”Œë¦¿ ì œê±°ë¨: ë°”ì¸ë”© ì‚­ì œ
    tplBtnTrackSubmitted.addEventListener("click", () => {
      loadTemplateIntoEditor(
        "/track-request-submitted.html",
        "[customer] ê³ ê°ë‹˜ê»˜, AUDIONYX ê°œì¸ìŒì› ì‹ ì²­ ì™„ë£Œ"
      );
    });

    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loggedOut.classList.add("hidden");
        loggedIn.classList.remove("hidden");
        mailFormContainer.classList.remove("hidden");
        userInfo.textContent = `ğŸ‘¤ ${user.displayName || user.email}`;
      } else {
        loggedOut.classList.remove("hidden");
        loggedIn.classList.add("hidden");
        mailFormContainer.classList.add("hidden");
      }
    });

    // ë¡œê·¸ì¸ (íŒì—… ì°¨ë‹¨/ë„ë©”ì¸ ì´ìŠˆ í´ë°±)
    loginBtn.addEventListener("click", async () => {
      try {
        if (location.protocol === 'file:') {
          showResult("âŒ ë¡œì»¬ íŒŒì¼ë¡œ ì—´ë ¸ìŠµë‹ˆë‹¤. http(s) ë˜ëŠ” localhostì—ì„œ ì ‘ì†í•´ ì£¼ì„¸ìš”.", "error");
          return;
        }
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
        const code = error?.code || '';
        if (code === 'auth/popup-blocked' || code === 'auth/popup-closed-by-user') {
          try {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            const { signInWithRedirect } = await import('https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js');
            await signInWithRedirect(auth, provider);
            return;
          } catch (redirErr) {
            console.error('ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¡œê·¸ì¸ ì˜¤ë¥˜:', redirErr);
          }
        }
        if (code === 'auth/unauthorized-domain') {
          showResult("âŒ ì¸ì¦ ë„ë©”ì¸ì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Firebase Auth ì„¤ì •ì—ì„œ í˜„ì¬ ë„ë©”ì¸ì„ í—ˆìš© ëª©ë¡ì— ì¶”ê°€í•˜ì„¸ìš”.", "error");
          return;
        }
        showResult(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${code} ${error?.message || ''}`.trim(), "error");
      }
    });

    // ë¡œê·¸ì•„ì›ƒ
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error);
      }
    });

    // ë¯¸ë¦¬ë³´ê¸°
    previewBtn.addEventListener("click", () => {
      const raw = document.getElementById("html").value;
      const html = toHtmlPreserveLineBreaks(raw);
      previewContent.innerHTML = html;
      previewModal.classList.remove("hidden");
    });

    closePreview.addEventListener("click", () => {
      previewModal.classList.add("hidden");
    });

    // ë©”ì¼ ë°œì†¡
    mailForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const emails = getAllEmails();
      const subject = document.getElementById("subject").value.trim();
      const rawHtmlInput = document.getElementById("html").value;
      const html = toHtmlPreserveLineBreaks(rawHtmlInput);

      // ìœ íš¨ì„± ê²€ì¦
      if (emails.length === 0) {
        showResult("âŒ ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      if (!subject || !html) {
        showResult("âŒ ì œëª©ê³¼ ë©”ì¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      // ì¸ì¦ ìƒíƒœ í™•ì¸
      const currentUser = auth.currentUser;
      if (!currentUser) {
        showResult("âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
        return;
      }

      console.log("ë°œì†¡ ëŒ€ìƒ ì´ë©”ì¼:", emails);
      console.log("ì´ë©”ì¼ ê°œìˆ˜:", emails.length);

      sendBtn.disabled = true;
      sendBtn.textContent = `ğŸ“¨ ${emails.length}ê°œ ì´ë©”ì¼ë¡œ ê°œë³„ ë°œì†¡ ì¤‘...`;

      try {
        // onRequest í•¨ìˆ˜ URL - us-central1 ë¦¬ì „ ë° í”„ë¡œì íŠ¸ IDì— ë§ê²Œ ì„¤ì •
        const functionUrl = "https://us-central1-audionyx-a7b2e.cloudfunctions.net/sendMail";
        
        let sentCount = 0;
        const sentEmails = [];
        const failedEmails = [];

        for (let i = 0; i < emails.length; i++) {
          const email = emails[i];
          
          try {
            sendBtn.textContent = `ğŸ“¨ ë°œì†¡ ì¤‘... (${i + 1}/${emails.length})`;
            
            const idToken = await currentUser.getIdToken();

            const mailData = { 
              to: email,
              subject, 
              html,
              ...(typeof currentAttachments !== "object" || currentAttachments === null ? {} : { attachments: currentAttachments })
            };

            const response = await fetch(functionUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${idToken}`
              },
              body: JSON.stringify(mailData)
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
              throw new Error(result.error || `HTTP error! status: ${response.status}`);
            }
            
            console.log(`ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ: ${email}`, result);
            sentCount++;
            sentEmails.push(email);

            if (i < emails.length - 1) {
              await new Promise(resolve => setTimeout(resolve, 500));
            }
            
          } catch (emailError) {
            console.error(`ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ${email}`, emailError);
            failedEmails.push({ email, error: emailError.message });
          }
        }
        
        // ë°œì†¡ ê²°ê³¼ ì²˜ë¦¬
        if (sentCount === emails.length) {
          showResult(
            `âœ… ê°œë³„ ë©”ì¼ ë°œì†¡ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n` +
            `ğŸ“§ ë°œì†¡ ì™„ë£Œ: ${sentCount}ê°œ ì´ë©”ì¼ (ê°ê° 1ëŒ€1 ê°œë³„ ë°œì†¡)\n` +
            `ğŸ“‹ ìˆ˜ì‹ ì: ${sentEmails.slice(0, 3).join(", ")}${sentEmails.length > 3 ? ` ì™¸ ${sentEmails.length - 3}ëª…` : ""}`, 
            "success"
          );
        } else if (sentCount > 0) {
          showResult(
            `âš ï¸ ì¼ë¶€ ë©”ì¼ ë°œì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n` +
            `âœ… ì„±ê³µ: ${sentCount}ê°œ ì´ë©”ì¼\n` +
            `âŒ ì‹¤íŒ¨: ${failedEmails.length}ê°œ ì´ë©”ì¼\n` +
            `ğŸ“‹ ì„±ê³µ ìˆ˜ì‹ ì: ${sentEmails.slice(0, 2).join(", ")}${sentEmails.length > 2 ? ` ì™¸ ${sentEmails.length - 2}ëª…` : ""}\n` +
            `ğŸ’¥ ì‹¤íŒ¨ ìˆ˜ì‹ ì: ${failedEmails.slice(0, 2).map(f => f.email).join(", ")}${failedEmails.length > 2 ? ` ì™¸ ${failedEmails.length - 2}ëª…` : ""}`, 
            "warning"
          );
        } else {
          showResult(
            `âŒ ëª¨ë“  ë©”ì¼ ë°œì†¡ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n` +
            `ğŸ’¥ ì‹¤íŒ¨ ìˆ˜ì‹ ì: ${failedEmails.slice(0, 3).map(f => f.email).join(", ")}${failedEmails.length > 3 ? ` ì™¸ ${failedEmails.length - 3}ëª…` : ""}\n` +
            `ğŸ’¬ ì£¼ìš” ì˜¤ë¥˜: ${failedEmails[0]?.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`, 
            "error"
          );
        }
        
        // í¼ ì´ˆê¸°í™”
        mailForm.reset();
        currentAttachments = null;
        
        if (!individualMode.classList.contains("hidden")) {
          emailList.innerHTML = `
            <div class="flex gap-3 email-item">
              <input type="email" class="audionyx-input flex-1 p-4 rounded-xl font-medium email-input" placeholder="recipient@example.com"/>
              <button type="button" class="audionyx-btn-secondary px-4 py-4 rounded-xl transition-all remove-email hover:bg-red-500 hover:border-red-500" title="ì´ë©”ì¼ ì œê±°">
                <span class="text-lg">ğŸ—‘ï¸</span>
              </button>
            </div>
          `;
          document.querySelector(".email-input").addEventListener("input", updateEmailCount);
          document.querySelector(".remove-email").addEventListener("click", (e) => {
            if (emailList.children.length > 1) {
              e.target.closest(".email-item").remove();
              updateEmailCount();
            }
          });
        }
        
        updateEmailCount();
        
      } catch (error) {
        console.error("ë©”ì¼ ë°œì†¡ í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜:", error);
        showResult(
          `âŒ ë©”ì¼ ë°œì†¡ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n` +
          `ğŸ’¬ ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message}`, 
          "error"
        );
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "ğŸ“¨ ê°œë³„ ë©”ì¼ ë°œì†¡ (1ëŒ€1)";
      }
    });

    // ê²°ê³¼ í‘œì‹œ
    function showResult(message, type) {
      let bgClass, icon;
      
      switch(type) {
        case "success":
          bgClass = "audionyx-success";
          icon = "âœ…";
          break;
        case "warning":
          bgClass = "audionyx-warning";
          icon = "âš ï¸";
          break;
        case "error":
        default:
          bgClass = "audionyx-error";
          icon = "âŒ";
          break;
      }
      
      result.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="text-2xl">${icon}</span>
          <div class="flex-1">
            <pre class="whitespace-pre-wrap font-sans leading-relaxed">${message}</pre>
          </div>
        </div>
      `;
      
      result.className = `mt-8 p-6 rounded-2xl ${bgClass}`;
      result.classList.remove("hidden");
      
      // warningì´ë‚˜ errorì¸ ê²½ìš° ë” ì˜¤ë˜ í‘œì‹œ
      const displayTime = type === "error" || type === "warning" ? 8000 : 5000;
      
      setTimeout(() => {
        result.classList.add("hidden");
      }, displayTime);
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    previewModal.addEventListener("click", (e) => {
      if (e.target === previewModal) {
        previewModal.classList.add("hidden");
      }
    });
  </script>
</body>
</html> 