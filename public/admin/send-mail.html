<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ë©”ì¼ ë°œì†¡ - Audionyx</title>
  <link href="https://unpkg.com/tailwindcss@2/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    .bg-mint-500 { background-color: #20B2AA; }
    .bg-mint-600 { background-color: #008B8B; }
    .hover\:bg-mint-600:hover { background-color: #008B8B; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container mx-auto px-6 py-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-8 text-center">ğŸ“§ Audionyx ë©”ì¼ ë°œì†¡</h1>
      
      <!-- ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ -->
      <div id="auth-status" class="mb-6 p-4 rounded-lg bg-gray-800">
        <div id="logged-out" class="text-center">
          <p class="mb-4">ë©”ì¼ì„ ë°œì†¡í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
          <button id="login-btn" class="px-6 py-2 bg-green-500 hover:bg-green-600 rounded-lg font-semibold transition-colors">
            ğŸ”‘ Google ë¡œê·¸ì¸
          </button>
        </div>
        <div id="logged-in" class="hidden">
          <div class="flex justify-between items-center">
            <span id="user-info" class="text-green-400"></span>
            <button id="logout-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded text-sm transition-colors">
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </div>

      <!-- ë©”ì¼ ë°œì†¡ í¼ -->
      <div id="mail-form-container" class="hidden">
        <form id="mail-form" class="space-y-6 bg-gray-800 p-6 rounded-lg">
          <div>
            <label for="to" class="block text-sm font-medium mb-2">ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼</label>
            <input 
              id="to" 
              type="email" 
              class="w-full p-3 text-black rounded-lg border border-gray-300 focus:ring-2 focus:ring-mint-500 focus:border-transparent" 
              placeholder="recipient@example.com"
              required
            />
          </div>
          
          <div>
            <label for="subject" class="block text-sm font-medium mb-2">ì œëª©</label>
            <input 
              id="subject" 
              type="text" 
              class="w-full p-3 text-black rounded-lg border border-gray-300 focus:ring-2 focus:ring-mint-500 focus:border-transparent" 
              placeholder="ë©”ì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>
          
          <div>
            <label for="html" class="block text-sm font-medium mb-2">ë©”ì¼ ë‚´ìš© (HTML)</label>
            <textarea 
              id="html" 
              rows="12"
              class="w-full p-3 text-black rounded-lg border border-gray-300 focus:ring-2 focus:ring-mint-500 focus:border-transparent font-mono text-sm" 
              placeholder="<h1>ì•ˆë…•í•˜ì„¸ìš”!</h1><p>ë©”ì¼ ë³¸ë¬¸ì„ HTMLë¡œ ì‘ì„±í•˜ì„¸ìš”.</p>"
              required
            ></textarea>
          </div>
          
          <div class="flex gap-4">
            <button 
              type="submit" 
              class="flex-1 bg-mint-500 hover:bg-mint-600 text-white p-3 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              id="send-btn"
            >
              ğŸ“¨ ë©”ì¼ ë°œì†¡
            </button>
            <button 
              type="button" 
              id="preview-btn"
              class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors"
            >
              ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
            </button>
          </div>
        </form>
      </div>

      <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
      <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white text-black p-6 rounded-lg max-w-4xl max-h-96 overflow-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">ë©”ì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
            <button id="close-preview" class="text-gray-500 hover:text-gray-700">âœ•</button>
          </div>
          <div id="preview-content" class="border p-4 rounded"></div>
        </div>
      </div>

      <!-- ë°œì†¡ ê²°ê³¼ -->
      <div id="result" class="mt-6 p-4 rounded-lg hidden"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-functions.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBP926ULg9wNUNGjQy0fMjRxUeS4XyeG6M",
      authDomain: "audionyx-a7b2e.firebaseapp.com",
      projectId: "audionyx-a7b2e",
      storageBucket: "audionyx-a7b2e.firebasestorage.app",
      messagingSenderId: "1002069862376",
      appId: "1:1002069862376:web:669c93bca8ab2f1d09665d",
      measurementId: "G-P6GNNYLJ38"
    };

    const app = initializeApp(firebaseConfig);
    const functions = getFunctions(app);
    const auth = getAuth(app);

    // DOM ìš”ì†Œë“¤
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const loggedOut = document.getElementById("logged-out");
    const loggedIn = document.getElementById("logged-in");
    const userInfo = document.getElementById("user-info");
    const mailFormContainer = document.getElementById("mail-form-container");
    const mailForm = document.getElementById("mail-form");
    const sendBtn = document.getElementById("send-btn");
    const previewBtn = document.getElementById("preview-btn");
    const previewModal = document.getElementById("preview-modal");
    const previewContent = document.getElementById("preview-content");
    const closePreview = document.getElementById("close-preview");
    const result = document.getElementById("result");

    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loggedOut.classList.add("hidden");
        loggedIn.classList.remove("hidden");
        mailFormContainer.classList.remove("hidden");
        userInfo.textContent = `ğŸ‘¤ ${user.displayName || user.email}`;
      } else {
        loggedOut.classList.remove("hidden");
        loggedIn.classList.add("hidden");
        mailFormContainer.classList.add("hidden");
      }
    });

    // ë¡œê·¸ì¸
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch (error) {
        console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
        showResult("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
      }
    });

    // ë¡œê·¸ì•„ì›ƒ
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error);
      }
    });

    // ë¯¸ë¦¬ë³´ê¸°
    previewBtn.addEventListener("click", () => {
      const html = document.getElementById("html").value;
      previewContent.innerHTML = html;
      previewModal.classList.remove("hidden");
    });

    closePreview.addEventListener("click", () => {
      previewModal.classList.add("hidden");
    });

    // ë©”ì¼ ë°œì†¡
    mailForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const to = document.getElementById("to").value.trim();
      const subject = document.getElementById("subject").value.trim();
      const html = document.getElementById("html").value;

      if (!to || !subject || !html) {
        showResult("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      // ì¸ì¦ ìƒíƒœ ë””ë²„ê¹…
      const currentUser = auth.currentUser;
      console.log("í˜„ì¬ ì‚¬ìš©ì:", currentUser);
      console.log("ì¸ì¦ í† í°:", currentUser ? await currentUser.getIdToken() : "ì—†ìŒ");

      // ì „ì†¡í•  ë°ì´í„° ë””ë²„ê¹…
      const mailData = { to, subject, html };
      console.log("ì „ì†¡í•  ë°ì´í„°:", mailData);
      console.log("ë°ì´í„° íƒ€ì…:", {
        to: typeof to,
        subject: typeof subject, 
        html: typeof html
      });

      sendBtn.disabled = true;
      sendBtn.textContent = "ğŸ“¨ ë°œì†¡ ì¤‘...";

      try {
        const sendMail = httpsCallable(functions, "sendMail");
        const result = await sendMail(mailData);
        console.log("Functions ì‘ë‹µ:", result);
        
        showResult(`âœ… ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\në°›ëŠ” ì‚¬ëŒ: ${to}`, "success");
        mailForm.reset();
      } catch (error) {
        console.error("ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜:", error);
        console.error("ì˜¤ë¥˜ ìƒì„¸:", {
          code: error.code,
          message: error.message,
          details: error.details
        });
        showResult(`âŒ ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ${error.message}`, "error");
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "ğŸ“¨ ë©”ì¼ ë°œì†¡";
      }
    });

    // ê²°ê³¼ í‘œì‹œ
    function showResult(message, type) {
      result.textContent = message;
      result.className = `mt-6 p-4 rounded-lg ${type === "success" ? "bg-green-800 text-green-200" : "bg-red-800 text-red-200"}`;
      result.classList.remove("hidden");
      
      setTimeout(() => {
        result.classList.add("hidden");
      }, 5000);
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    previewModal.addEventListener("click", (e) => {
      if (e.target === previewModal) {
        previewModal.classList.add("hidden");
      }
    });
  </script>
</body>
</html> 